"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.SFTPStack = void 0;
const aws_cdk_lib_1 = require("aws-cdk-lib");
const aws_ec2_1 = require("aws-cdk-lib/aws-ec2");
const aws_iam_1 = require("aws-cdk-lib/aws-iam");
const aws_s3_1 = require("aws-cdk-lib/aws-s3");
const aws_transfer_1 = require("aws-cdk-lib/aws-transfer");
const common_1 = require("../utils/common");
const sftp_nested_users_1 = require("./sftp-nested-users");
class SFTPStack extends aws_cdk_lib_1.Stack {
    constructor(scope, id, config, userCfg, props) {
        super(scope, id, props);
        this.config = config;
        this.userConfig = userCfg;
        this.createElasticIPs();
        this.createS3Bucket();
        this.outputEIPBucket();
        if (this.config.sftpServiceEnabled) {
            this.createSFTP();
            new sftp_nested_users_1.SFTPUsersNestedStack(this, 'SFTPUsers', userCfg, this.sftpBucket.bucketName, this.sftpServer.attrServerId);
            // this.outputSFTPEndpoint()
        }
        // this.addTags()
        // this.createParams()
    }
    createS3Bucket() {
        this.sftpBucket = new aws_s3_1.Bucket(this, 'sftp-bucket', {
            bucketName: this.config.bucketName,
            encryption: aws_s3_1.BucketEncryption.S3_MANAGED,
            enforceSSL: true,
            publicReadAccess: false,
            blockPublicAccess: aws_s3_1.BlockPublicAccess.BLOCK_ALL,
            versioned: true,
            removalPolicy: aws_cdk_lib_1.RemovalPolicy.DESTROY,
        });
    }
    createLoggingRole() {
        return new aws_iam_1.Role(this, `SFTPLoggingRole`, {
            roleName: `${aws_cdk_lib_1.Aws.STACK_NAME}-Logging-Role`,
            description: `Logging for SFTP Servier`,
            assumedBy: new aws_iam_1.CompositePrincipal(new aws_iam_1.ServicePrincipal('transfer.amazonaws.com')),
            inlinePolicies: {
                LoggingPolicy: this.createLoggingPolicy(),
            },
        });
    }
    // ####### IAM ROLES #######
    createLoggingPolicy() {
        const loggingPolicy = new aws_iam_1.PolicyStatement({
            sid: 'SFTPCloudWatchLogging',
            actions: ['logs:CreateLogStream', 'logs:DescribeLogStreams', 'logs:CreateLogGroup', 'logs:PutLogEvents'],
            effect: aws_iam_1.Effect.ALLOW,
            resources: ['arn:aws:logs:*:*:log-group:/aws/transfer/*'],
        });
        const userBucketInlinePolicyDocument = new aws_iam_1.PolicyDocument({
            statements: [loggingPolicy],
        });
        return userBucketInlinePolicyDocument;
    }
    createElasticIPs() {
        this.eIps = Array.from(Array(3).keys()).map((i) => new aws_ec2_1.CfnEIP(this, `EIP${i}`, {
            tags: [
                {
                    key: 'Name',
                    value: `${aws_cdk_lib_1.Aws.STACK_NAME}-EIP${i}`,
                },
            ],
        }));
    }
    createSFTP() {
        const securityGroup = new aws_ec2_1.SecurityGroup(this, 'SecurityGroup', {
            vpc: aws_ec2_1.Vpc.fromLookup(this, 'VPC', {
                vpcId: this.config.vpcId,
            }),
            allowAllOutbound: true,
            securityGroupName: 'SFTP-Access',
            description: 'SFTP Access',
        });
        //  Iterate over users and allowd IPS for each user and add it to security group
        Object.entries(this.userConfig.users).map(([i, user]) => user.allowedIps.map((ip) => securityGroup.addIngressRule(aws_ec2_1.Peer.ipv4(ip), aws_ec2_1.Port.tcp(22), `Allow SFTP traffic for user - ${user.name}`)));
        this.sftpServer = new aws_transfer_1.CfnServer(this, 'SFTPServer', {
            endpointType: 'VPC',
            loggingRole: this.createLoggingRole().roleArn,
            protocols: ['SFTP'],
            endpointDetails: {
                vpcId: this.config.vpcId,
                addressAllocationIds: this.eIps.map((eip) => eip.attrAllocationId),
                // works wiht public
                subnetIds: common_1.convertStringToArray(this.config.publicSubnetIds),
                securityGroupIds: [securityGroup.securityGroupId],
            },
        });
    }
    outputEIPBucket() {
        this.eIps.map((eip, i) => new aws_cdk_lib_1.CfnOutput(this, `EIPOutput${i}`, {
            value: eip.ref,
            description: `IP For SFTP server`,
            exportName: `SFTP${i}`,
        }));
        new aws_cdk_lib_1.CfnOutput(this, `SFTPBucketOutput`, {
            value: this.sftpBucket.bucketName,
            description: `SFTP S3 Bucket`,
            exportName: `SFTPBucket`,
        });
    }
}
exports.SFTPStack = SFTPStack;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2Z0cC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInNmdHAudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsNkNBQStFO0FBQy9FLGlEQUE2RTtBQUM3RSxpREFPNkI7QUFDN0IsK0NBQWlGO0FBQ2pGLDJEQUFxRDtBQUdyRCw0Q0FBdUQ7QUFDdkQsMkRBQTJEO0FBRTNELE1BQWEsU0FBVSxTQUFRLG1CQUFLO0lBT2xDLFlBQVksS0FBZ0IsRUFBRSxFQUFVLEVBQUUsTUFBa0IsRUFBRSxPQUFjLEVBQUUsS0FBa0I7UUFDOUYsS0FBSyxDQUFDLEtBQUssRUFBRSxFQUFFLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFFeEIsSUFBSSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUM7UUFDckIsSUFBSSxDQUFDLFVBQVUsR0FBRyxPQUFPLENBQUM7UUFFMUIsSUFBSSxDQUFDLGdCQUFnQixFQUFFLENBQUM7UUFDeEIsSUFBSSxDQUFDLGNBQWMsRUFBRSxDQUFDO1FBQ3RCLElBQUksQ0FBQyxlQUFlLEVBQUUsQ0FBQztRQUV2QixJQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsa0JBQWtCLEVBQUU7WUFDbEMsSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFDO1lBQ2xCLElBQUksd0NBQW9CLENBQUMsSUFBSSxFQUFFLFdBQVcsRUFBRSxPQUFPLEVBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxVQUFVLEVBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxZQUFZLENBQUMsQ0FBQztZQUMvRyw0QkFBNEI7U0FDN0I7UUFFRCxpQkFBaUI7UUFDakIsc0JBQXNCO0lBQ3hCLENBQUM7SUFFRCxjQUFjO1FBQ1osSUFBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLGVBQU0sQ0FBQyxJQUFJLEVBQUUsYUFBYSxFQUFFO1lBQ2hELFVBQVUsRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLFVBQVU7WUFDbEMsVUFBVSxFQUFFLHlCQUFnQixDQUFDLFVBQVU7WUFDdkMsVUFBVSxFQUFFLElBQUk7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N0MsU0FBUyxFQUFFLENBQUMsTUFBTSxDQUFDO1lBQ25CLGVBQWUsRUFBRTtnQkFDZixLQUFLLEVBQUUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLO2dCQUN4QixvQkFBb0IsRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUMsR0FBRyxDQUFDLGdCQUFnQixDQUFDO2dCQUNsRSxvQkFBb0I7Z0JBQ3BCLFNBQVMsRUFBRSw2QkFBb0IsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLGVBQWUsQ0FBQztnQkFDNUQsZ0JBQWdCLEVBQUUsQ0FBQyxhQUFhLENBQUMsZUFBZSxDQUFDO2FBQ2xEO1NBQ0YsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVELGVBQWU7UUFDYixJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FDWCxDQUFDLEdBQUcsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUNULElBQUksdUJBQVMsQ0FBQyxJQUFJLEVBQUUsWUFBWSxDQUFDLEVBQUUsRUFBRTtZQUNuQyxLQUFLLEVBQUUsR0FBRyxDQUFDLEdBQUc7WUFDZCxXQUFXLEVBQUUsb0JBQW9CO1lBQ2pDLFVBQVUsRUFBRSxPQUFPLENBQUMsRUFBRTtTQUN2QixDQUFDLENBQ0wsQ0FBQztRQUVGLElBQUksdUJBQVMsQ0FBQyxJQUFJLEVBQUUsa0JBQWtCLEVBQUU7WUFDdEMsS0FBSyxFQUFFLElBQUksQ0FBQyxVQUFVLENBQUMsVUFBVTtZQUNqQyxXQUFXLEVBQUUsZ0JBQWdCO1lBQzdCLFVBQVUsRUFBRSxZQUFZO1NBQ3pCLENBQUMsQ0FBQztJQUNMLENBQUM7Q0FFRjtBQWhJRCw4QkFnSUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBd3MsIENmbk91dHB1dCwgUmVtb3ZhbFBvbGljeSwgU3RhY2ssIFN0YWNrUHJvcHMgfSBmcm9tICdhd3MtY2RrLWxpYic7XG5pbXBvcnQgeyBDZm5FSVAsIFBlZXIsIFBvcnQsIFNlY3VyaXR5R3JvdXAsIFZwYyB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1lYzInO1xuaW1wb3J0IHtcbiAgQ29tcG9zaXRlUHJpbmNpcGFsLFxuICBFZmZlY3QsXG4gIFBvbGljeURvY3VtZW50LFxuICBQb2xpY3lTdGF0ZW1lbnQsXG4gIFJvbGUsXG4gIFNlcnZpY2VQcmluY2lwYWwsXG59IGZyb20gJ2F3cy1jZGstbGliL2F3cy1pYW0nO1xuaW1wb3J0IHsgQmxvY2tQdWJsaWNBY2Nlc3MsIEJ1Y2tldCwgQnVja2V0RW5jcnlwdGlvbiB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1zMyc7XG5pbXBvcnQgeyBDZm5TZXJ2ZXIgfSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtdHJhbnNmZXInO1xuaW1wb3J0IHsgQ29uc3RydWN0IH0gZnJvbSAnY29uc3RydWN0cyc7XG5pbXBvcnQgeyBTRlRQQ29uZmlnLCBVc2VycyB9IGZyb20gJy4uLy4uL2ludGVyZmFjZXMvbGliL3NmdHAvaW50ZXJmYWNlcyc7XG5pbXBvcnQgeyBjb252ZXJ0U3RyaW5nVG9BcnJheSB9IGZyb20gJy4uL3V0aWxzL2NvbW1vbic7XG5pbXBvcnQgeyBTRlRQVXNlcnNOZXN0ZWRTdGFjayB9IGZyb20gJy4vc2Z0cC1uZXN0ZWQtdXNlcnMnO1xuXG5leHBvcnQgY2xhc3MgU0ZUUFN0YWNrIGV4dGVuZHMgU3RhY2sge1xuICBjb25maWc6IFNGVFBDb25maWc7XG4gIHVzZXJDb25maWc6IFVzZXJzO1xuICBlSXBzOiBDZm5FSVBbXTtcbiAgc2Z0cFNlcnZlcjogQ2ZuU2VydmVyO1xuICBzZnRwQnVja2V0OiBCdWNrZXQ7XG5cbiAgY29uc3RydWN0b3Ioc2NvcGU6IENvbnN0cnVjdCwgaWQ6IHN0cmluZywgY29uZmlnOiBTRlRQQ29uZmlnLCB1c2VyQ2ZnOiBVc2VycywgcHJvcHM/OiBTdGFja1Byb3BzKSB7XG4gICAgc3VwZXIoc2NvcGUsIGlkLCBwcm9wcyk7XG5cbiAgICB0aGlzLmNvbmZpZyA9IGNvbmZpZztcbiAgICB0aGlzLnVzZXJDb25maWcgPSB1c2VyQ2ZnO1xuXG4gICAgdGhpcy5jcmVhdGVFbGFzdGljSVBzKCk7XG4gICAgdGhpcy5jcmVhdGVTM0J1Y2tldCgpO1xuICAgIHRoaXMub3V0cHV0RUlQQnVja2V0KCk7XG5cbiAgICBpZiAodGhpcy5jb25maWcuc2Z0cFNlcnZpY2VFbmFibGVkKSB7XG4gICAgICB0aGlzLmNyZWF0ZVNGVFAoKTtcbiAgICAgIG5ldyBTRlRQVXNlcnNOZXN0ZWRTdGFjayh0aGlzLCAnU0ZUUFVzZXJzJywgdXNlckNmZywgdGhpcy5zZnRwQnVja2V0LmJ1Y2tldE5hbWUsIHRoaXMuc2Z0cFNlcnZlci5hdHRyU2VydmVySWQpO1xuICAgICAgLy8gdGhpcy5vdXRwdXRTRlRQRW5kcG9pbnQoKVxuICAgIH1cblxuICAgIC8vIHRoaXMuYWRkVGFncygpXG4gICAgLy8gdGhpcy5jcmVhdGVQYXJhbXMoKVxuICB9XG5cbiAgY3JlYXRlUzNCdWNrZXQoKTogdm9pZCB7XG4gICAgdGhpcy5zZnRwQnVja2V0ID0gbmV3IEJ1Y2tldCh0aGlzLCAnc2Z0cC1idWNrZXQnLCB7XG4gICAgICBidWNrZXROYW1lOiB0aGlzLmNvbmZpZy5idWNrZXROYW1lLFxuICAgICAgZW5jcnlwdGlvbjogQnVja2V0RW5jcnlwdGlvbi5TM19NQU5BR0VELFxuICAgICAgZW5mb3JjZVNTTDogdHJ1ZSxcbiAgICAgIHB1YmxpY1JlYWRBY2Nlc3M6IGZhbHNlLFxuICAgICAgYmxvY2tQdWJsaWNBY2Nlc3M6IEJsb2NrUHVibGljQWNjZXNzLkJMT0NLX0FMTCxcbiAgICAgIHZlcnNpb25lZDogdHJ1ZSxcbiAgICAgIHJlbW92YWxQb2xpY3k6IFJlbW92YWxQb2xpY3kuREVTVFJPWSxcbiAgICB9KTtcbiAgfVxuXG4gIGNyZWF0ZUxvZ2dpbmdSb2xlKCk6IFJvbGUge1xuICAgIHJldHVybiBuZXcgUm9sZSh0aGlzLCBgU0ZUUExvZ2dpbmdSb2xlYCwge1xuICAgICAgcm9sZU5hbWU6IGAke0F3cy5TVEFDS19OQU1FfS1Mb2dnaW5nLVJvbGVgLFxuICAgICAgZGVzY3JpcHRpb246IGBMb2dnaW5nIGZvciBTRlRQIFNlcnZpZXJgLFxuICAgICAgYXNzdW1lZEJ5OiBuZXcgQ29tcG9zaXRlUHJpbmNpcGFsKG5ldyBTZXJ2aWNlUHJpbmNpcGFsKCd0cmFuc2Zlci5hbWF6b25hd3MuY29tJykpLFxuICAgICAgaW5saW5lUG9saWNpZXM6IHtcbiAgICAgICAgTG9nZ2luZ1BvbGljeTogdGhpcy5jcmVhdGVMb2dnaW5nUG9saWN5KCksXG4gICAgICB9LFxuICAgIH0pO1xuICB9XG5cbiAgLy8gIyMjIyMjIyBJQU0gUk9MRVMgIyMjIyMjI1xuICBjcmVhdGVMb2dnaW5nUG9saWN5KCk6IFBvbGljeURvY3VtZW50IHtcbiAgICBjb25zdCBsb2dnaW5nUG9saWN5ID0gbmV3IFBvbGljeVN0YXRlbWVudCh7XG4gICAgICBzaWQ6ICdTRlRQQ2xvdWRXYXRjaExvZ2dpbmcnLFxuICAgICAgYWN0aW9uczogWydsb2dzOkNyZWF0ZUxvZ1N0cmVhbScsICdsb2dzOkRlc2NyaWJlTG9nU3RyZWFtcycsICdsb2dzOkNyZWF0ZUxvZ0dyb3VwJywgJ2xvZ3M6UHV0TG9nRXZlbnRzJ10sXG4gICAgICBlZmZlY3Q6IEVmZmVjdC5BTExPVyxcbiAgICAgIHJlc291cmNlczogWydhcm46YXdzOmxvZ3M6KjoqOmxvZy1ncm91cDovYXdzL3RyYW5zZmVyLyonXSxcbiAgICB9KTtcblxuICAgIGNvbnN0IHVzZXJCdWNrZXRJbmxpbmVQb2xpY3lEb2N1bWVudCA9IG5ldyBQb2xpY3lEb2N1bWVudCh7XG4gICAgICBzdGF0ZW1lbnRzOiBbbG9nZ2luZ1BvbGljeV0sXG4gICAgfSk7XG5cbiAgICByZXR1cm4gdXNlckJ1Y2tldElubGluZVBvbGljeURvY3VtZW50O1xuICB9XG5cbiAgY3JlYXRlRWxhc3RpY0lQcygpOiB2b2lkIHtcbiAgICB0aGlzLmVJcHMgPSBBcnJheS5mcm9tKEFycmF5KDMpLmtleXMoKSkubWFwKFxuICAgICAgKGkpID0+XG4gICAgICAgIG5ldyBDZm5FSVAodGhpcywgYEVJUCR7aX1gLCB7XG4gICAgICAgICAgdGFnczogW1xuICAgICAgICAgICAge1xuICAgICAgICAgICAgICBrZXk6ICdOYW1lJyxcbiAgICAgICAgICAgICAgdmFsdWU6IGAke0F3cy5TVEFDS19OQU1FfS1FSVAke2l9YCxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgXSxcbiAgICAgICAgfSksXG4gICAgKTtcbiAgfVxuXG4gIGNyZWF0ZVNGVFAoKTogdm9pZCB7XG4gICAgY29uc3Qgc2VjdXJpdHlHcm91cDogU2VjdXJpdHlHcm91cCA9IG5ldyBTZWN1cml0eUdyb3VwKHRoaXMsICdTZWN1cml0eUdyb3VwJywge1xuICAgICAgdnBjOiBWcGMuZnJvbUxvb2t1cCh0aGlzLCAnVlBDJywge1xuICAgICAgICB2cGNJZDogdGhpcy5jb25maWcudnBjSWQsXG4gICAgICB9KSxcbiAgICAgIGFsbG93QWxsT3V0Ym91bmQ6IHRydWUsXG4gICAgICBzZWN1cml0eUdyb3VwTmFtZTogJ1NGVFAtQWNjZXNzJyxcbiAgICAgIGRlc2NyaXB0aW9uOiAnU0ZUUCBBY2Nlc3MnLFxuICAgIH0pO1xuXG4gICAgLy8gIEl0ZXJhdGUgb3ZlciB1c2VycyBhbmQgYWxsb3dkIElQUyBmb3IgZWFjaCB1c2VyIGFuZCBhZGQgaXQgdG8gc2VjdXJpdHkgZ3JvdXBcbiAgICBPYmplY3QuZW50cmllcyh0aGlzLnVzZXJDb25maWcudXNlcnMpLm1hcCgoW2ksIHVzZXJdKSA9PlxuICAgICAgdXNlci5hbGxvd2VkSXBzLm1hcCgoaXApID0+XG4gICAgICAgIHNlY3VyaXR5R3JvdXAuYWRkSW5ncmVzc1J1bGUoUGVlci5pcHY0KGlwKSwgUG9ydC50Y3AoMjIpLCBgQWxsb3cgU0ZUUCB0cmFmZmljIGZvciB1c2VyIC0gJHt1c2VyLm5hbWV9YCksXG4gICAgICApLFxuICAgICk7XG5cbiAgICB0aGlzLnNmdHBTZXJ2ZXIgPSBuZXcgQ2ZuU2VydmVyKHRoaXMsICdTRlRQU2VydmVyJywge1xuICAgICAgZW5kcG9pbnRUeXBlOiAnVlBDJyxcbiAgICAgIGxvZ2dpbmdSb2xlOiB0aGlzLmNyZWF0ZUxvZ2dpbmdSb2xlKCkucm9sZUFybixcbiAgICAgIHByb3RvY29sczogWydTRlRQJ10sXG4gICAgICBlbmRwb2ludERldGFpbHM6IHtcbiAgICAgICAgdnBjSWQ6IHRoaXMuY29uZmlnLnZwY0lkLFxuICAgICAgICBhZGRyZXNzQWxsb2NhdGlvbklkczogdGhpcy5lSXBzLm1hcCgoZWlwKSA9PiBlaXAuYXR0ckFsbG9jYXRpb25JZCksXG4gICAgICAgIC8vIHdvcmtzIHdpaHQgcHVibGljXG4gICAgICAgIHN1Ym5ldElkczogY29udmVydFN0cmluZ1RvQXJyYXkodGhpcy5jb25maWcucHVibGljU3VibmV0SWRzKSxcbiAgICAgICAgc2VjdXJpdHlHcm91cElkczogW3NlY3VyaXR5R3JvdXAuc2VjdXJpdHlHcm91cElkXSxcbiAgICAgIH0sXG4gICAgfSk7XG4gIH1cblxuICBvdXRwdXRFSVBCdWNrZXQoKTogdm9pZCB7XG4gICAgdGhpcy5lSXBzLm1hcChcbiAgICAgIChlaXAsIGkpID0+XG4gICAgICAgIG5ldyBDZm5PdXRwdXQodGhpcywgYEVJUE91dHB1dCR7aX1gLCB7XG4gICAgICAgICAgdmFsdWU6IGVpcC5yZWYsXG4gICAgICAgICAgZGVzY3JpcHRpb246IGBJUCBGb3IgU0ZUUCBzZXJ2ZXJgLFxuICAgICAgICAgIGV4cG9ydE5hbWU6IGBTRlRQJHtpfWAsXG4gICAgICAgIH0pLFxuICAgICk7XG5cbiAgICBuZXcgQ2ZuT3V0cHV0KHRoaXMsIGBTRlRQQnVja2V0T3V0cHV0YCwge1xuICAgICAgdmFsdWU6IHRoaXMuc2Z0cEJ1Y2tldC5idWNrZXROYW1lLFxuICAgICAgZGVzY3JpcHRpb246IGBTRlRQIFMzIEJ1Y2tldGAsXG4gICAgICBleHBvcnROYW1lOiBgU0ZUUEJ1Y2tldGAsXG4gICAgfSk7XG4gIH1cblxufVxuIl19
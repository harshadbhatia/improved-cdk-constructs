"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.SFTPStack = void 0;
const aws_cdk_lib_1 = require("aws-cdk-lib");
const aws_ec2_1 = require("aws-cdk-lib/aws-ec2");
const aws_iam_1 = require("aws-cdk-lib/aws-iam");
const aws_s3_1 = require("aws-cdk-lib/aws-s3");
const aws_transfer_1 = require("aws-cdk-lib/aws-transfer");
const common_1 = require("../utils/common");
const sftp_nested_users_1 = require("./sftp-nested-users");
class SFTPStack extends aws_cdk_lib_1.Stack {
    constructor(scope, id, config, userCfg, props) {
        super(scope, id, props);
        this.config = config;
        this.userConfig = userCfg;
        this.createElasticIPs();
        this.createS3Bucket();
        this.outputEIPBucket();
        if (this.config.sftpServiceEnabled) {
            this.createSFTP();
            new sftp_nested_users_1.SFTPUsersNestedStack(this, 'SFTPUsers', userCfg, this.sftpBucket.bucketName, this.sftpServer.attrServerId);
            // this.outputSFTPEndpoint()
        }
        // this.addTags()
        // this.createParams()
    }
    createS3Bucket() {
        this.sftpBucket = new aws_s3_1.Bucket(this, 'sftp-bucket', {
            bucketName: this.config.bucketName,
            encryption: aws_s3_1.BucketEncryption.S3_MANAGED,
            enforceSSL: true,
            publicReadAccess: false,
            blockPublicAccess: aws_s3_1.BlockPublicAccess.BLOCK_ALL,
            versioned: true,
            removalPolicy: aws_cdk_lib_1.RemovalPolicy.DESTROY,
        });
    }
    createLoggingRole() {
        return new aws_iam_1.Role(this, `SFTPLoggingRole`, {
            roleName: `${aws_cdk_lib_1.Aws.STACK_NAME}-Logging-Role`,
            description: `Logging for SFTP Servier`,
            assumedBy: new aws_iam_1.CompositePrincipal(new aws_iam_1.ServicePrincipal('transfer.amazonaws.com')),
            inlinePolicies: {
                LoggingPolicy: this.createLoggingPolicy(),
            },
        });
    }
    // ####### IAM ROLES #######
    createLoggingPolicy() {
        const loggingPolicy = new aws_iam_1.PolicyStatement({
            sid: 'SFTPCloudWatchLogging',
            actions: ['logs:CreateLogStream', 'logs:DescribeLogStreams', 'logs:CreateLogGroup', 'logs:PutLogEvents'],
            effect: aws_iam_1.Effect.ALLOW,
            resources: ['arn:aws:logs:*:*:log-group:/aws/transfer/*'],
        });
        const userBucketInlinePolicyDocument = new aws_iam_1.PolicyDocument({
            statements: [loggingPolicy],
        });
        return userBucketInlinePolicyDocument;
    }
    createElasticIPs() {
        this.eIps = Array.from(Array(3).keys()).map((i) => new aws_ec2_1.CfnEIP(this, `EIP${i}`, {
            tags: [
                {
                    key: 'Name',
                    value: `${aws_cdk_lib_1.Aws.STACK_NAME}-EIP${i}`,
                },
            ],
        }));
    }
    createSFTP() {
        const securityGroup = new aws_ec2_1.SecurityGroup(this, 'SecurityGroup', {
            vpc: aws_ec2_1.Vpc.fromLookup(this, 'VPC', {
                vpcId: this.config.vpcId,
            }),
            allowAllOutbound: true,
            securityGroupName: 'SFTP-Access',
            description: 'SFTP Access',
        });
        //  Iterate over users and allowd IPS for each user and add it to security group
        Object.entries(this.userConfig.users).map(([i, user]) => user.allowedIps.map((ip) => securityGroup.addIngressRule(aws_ec2_1.Peer.ipv4(ip), aws_ec2_1.Port.tcp(22), `Allow SFTP traffic for user - ${user.name}`)));
        this.sftpServer = new aws_transfer_1.CfnServer(this, 'SFTPServer', {
            endpointType: 'VPC',
            loggingRole: this.createLoggingRole().roleArn,
            protocols: ['SFTP'],
            endpointDetails: {
                vpcId: this.config.vpcId,
                addressAllocationIds: this.eIps.map((eip) => eip.attrAllocationId),
                // works wiht public
                subnetIds: (0, common_1.convertStringToArray)(this.config.publicSubnetIds),
                securityGroupIds: [securityGroup.securityGroupId],
            },
        });
    }
    outputEIPBucket() {
        this.eIps.map((eip, i) => new aws_cdk_lib_1.CfnOutput(this, `EIPOutput${i}`, {
            value: eip.ref,
            description: `IP For SFTP server`,
            exportName: `SFTP${i}`,
        }));
        new aws_cdk_lib_1.CfnOutput(this, `SFTPBucketOutput`, {
            value: this.sftpBucket.bucketName,
            description: `SFTP S3 Bucket`,
            exportName: `SFTPBucket`,
        });
    }
}
exports.SFTPStack = SFTPStack;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2Z0cC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInNmdHAudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsNkNBQStFO0FBQy9FLGlEQUE2RTtBQUM3RSxpREFPNkI7QUFDN0IsK0NBQWlGO0FBQ2pGLDJEQUFxRDtBQUdyRCw0Q0FBdUQ7QUFDdkQsMkRBQTJEO0FBRTNELE1BQWEsU0FBVSxTQUFRLG1CQUFLO0lBT2xDLFlBQVksS0FBZ0IsRUFBRSxFQUFVLEVBQUUsTUFBa0IsRUFBRSxPQUFjLEVBQUUsS0FBa0I7UUFDOUYsS0FBSyxDQUFDLEtBQUssRUFBRSxFQUFFLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFFeEIsSUFBSSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUM7UUFDckIsSUFBSSxDQUFDLFVBQVUsR0FBRyxPQUFPLENBQUM7UUFFMUIsSUFBSSxDQUFDLGdCQUFnQixFQUFFLENBQUM7UUFDeEIsSUFBSSxDQUFDLGNBQWMsRUFBRSxDQUFDO1FBQ3RCLElBQUksQ0FBQyxlQUFlLEVBQUUsQ0FBQztRQUV2QixJQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsa0JBQWtCLEVBQUU7WUFDbEMsSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFDO1lBQ2xCLElBQUksd0NBQW9CLENBQUMsSUFBSSxFQUFFLFdBQVcsRUFBRSxPQUFPLEVBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxVQUFVLEVBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxZQUFZLENBQUMsQ0FBQztZQUMvRyw0QkFBNEI7U0FDN0I7UUFFRCxpQkFBaUI7UUFDakIsc0JBQXNCO0lBQ3hCLENBQUM7SUFFRCxjQUFjO1FBQ1osSUFBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLGVBQU0sQ0FBQyxJQUFJLEVBQUUsYUFBYSxFQUFFO1lBQ2hELFVBQVUsRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLFVBQVU7WUFDbEMsVUFBVSxFQUFFLHlCQUFnQixDQUFDLFVBQVU7WUFDdkMsVUFBVSxFQUFFLElBQUk7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N0MsU0FBUyxFQUFFLENBQUMsTUFBTSxDQUFDO1lBQ25CLGVBQWUsRUFBRTtnQkFDZixLQUFLLEVBQUUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLO2dCQUN4QixvQkFBb0IsRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUMsR0FBRyxDQUFDLGdCQUFnQixDQUFDO2dCQUNsRSxvQkFBb0I7Z0JBQ3BCLFNBQVMsRUFBRSxJQUFBLDZCQUFvQixFQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsZUFBZSxDQUFDO2dCQUM1RCxnQkFBZ0IsRUFBRSxDQUFDLGFBQWEsQ0FBQyxlQUFlLENBQUM7YUFDbEQ7U0FDRixDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQsZUFBZTtRQUNiLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUNYLENBQUMsR0FBRyxFQUFFLENBQUMsRUFBRSxFQUFFLENBQ1QsSUFBSSx1QkFBUyxDQUFDLElBQUksRUFBRSxZQUFZLENBQUMsRUFBRSxFQUFFO1lBQ25DLEtBQUssRUFBRSxHQUFHLENBQUMsR0FBRztZQUNkLFdBQVcsRUFBRSxvQkFBb0I7WUFDakMsVUFBVSxFQUFFLE9BQU8sQ0FBQyxFQUFFO1NBQ3ZCLENBQUMsQ0FDTCxDQUFDO1FBRUYsSUFBSSx1QkFBUyxDQUFDLElBQUksRUFBRSxrQkFBa0IsRUFBRTtZQUN0QyxLQUFLLEVBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxVQUFVO1lBQ2pDLFdBQVcsRUFBRSxnQkFBZ0I7WUFDN0IsVUFBVSxFQUFFLFlBQVk7U0FDekIsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztDQUVGO0FBaElELDhCQWdJQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEF3cywgQ2ZuT3V0cHV0LCBSZW1vdmFsUG9saWN5LCBTdGFjaywgU3RhY2tQcm9wcyB9IGZyb20gJ2F3cy1jZGstbGliJztcbmltcG9ydCB7IENmbkVJUCwgUGVlciwgUG9ydCwgU2VjdXJpdHlHcm91cCwgVnBjIH0gZnJvbSAnYXdzLWNkay1saWIvYXdzLWVjMic7XG5pbXBvcnQge1xuICBDb21wb3NpdGVQcmluY2lwYWwsXG4gIEVmZmVjdCxcbiAgUG9saWN5RG9jdW1lbnQsXG4gIFBvbGljeVN0YXRlbWVudCxcbiAgUm9sZSxcbiAgU2VydmljZVByaW5jaXBhbCxcbn0gZnJvbSAnYXdzLWNkay1saWIvYXdzLWlhbSc7XG5pbXBvcnQgeyBCbG9ja1B1YmxpY0FjY2VzcywgQnVja2V0LCBCdWNrZXRFbmNyeXB0aW9uIH0gZnJvbSAnYXdzLWNkay1saWIvYXdzLXMzJztcbmltcG9ydCB7IENmblNlcnZlciB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy10cmFuc2Zlcic7XG5pbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tICdjb25zdHJ1Y3RzJztcbmltcG9ydCB7IFNGVFBDb25maWcsIFVzZXJzIH0gZnJvbSAnLi4vLi4vaW50ZXJmYWNlcy9saWIvc2Z0cC9pbnRlcmZhY2VzJztcbmltcG9ydCB7IGNvbnZlcnRTdHJpbmdUb0FycmF5IH0gZnJvbSAnLi4vdXRpbHMvY29tbW9uJztcbmltcG9ydCB7IFNGVFBVc2Vyc05lc3RlZFN0YWNrIH0gZnJvbSAnLi9zZnRwLW5lc3RlZC11c2Vycyc7XG5cbmV4cG9ydCBjbGFzcyBTRlRQU3RhY2sgZXh0ZW5kcyBTdGFjayB7XG4gIGNvbmZpZzogU0ZUUENvbmZpZztcbiAgdXNlckNvbmZpZzogVXNlcnM7XG4gIGVJcHM6IENmbkVJUFtdO1xuICBzZnRwU2VydmVyOiBDZm5TZXJ2ZXI7XG4gIHNmdHBCdWNrZXQ6IEJ1Y2tldDtcblxuICBjb25zdHJ1Y3RvcihzY29wZTogQ29uc3RydWN0LCBpZDogc3RyaW5nLCBjb25maWc6IFNGVFBDb25maWcsIHVzZXJDZmc6IFVzZXJzLCBwcm9wcz86IFN0YWNrUHJvcHMpIHtcbiAgICBzdXBlcihzY29wZSwgaWQsIHByb3BzKTtcblxuICAgIHRoaXMuY29uZmlnID0gY29uZmlnO1xuICAgIHRoaXMudXNlckNvbmZpZyA9IHVzZXJDZmc7XG5cbiAgICB0aGlzLmNyZWF0ZUVsYXN0aWNJUHMoKTtcbiAgICB0aGlzLmNyZWF0ZVMzQnVja2V0KCk7XG4gICAgdGhpcy5vdXRwdXRFSVBCdWNrZXQoKTtcblxuICAgIGlmICh0aGlzLmNvbmZpZy5zZnRwU2VydmljZUVuYWJsZWQpIHtcbiAgICAgIHRoaXMuY3JlYXRlU0ZUUCgpO1xuICAgICAgbmV3IFNGVFBVc2Vyc05lc3RlZFN0YWNrKHRoaXMsICdTRlRQVXNlcnMnLCB1c2VyQ2ZnLCB0aGlzLnNmdHBCdWNrZXQuYnVja2V0TmFtZSwgdGhpcy5zZnRwU2VydmVyLmF0dHJTZXJ2ZXJJZCk7XG4gICAgICAvLyB0aGlzLm91dHB1dFNGVFBFbmRwb2ludCgpXG4gICAgfVxuXG4gICAgLy8gdGhpcy5hZGRUYWdzKClcbiAgICAvLyB0aGlzLmNyZWF0ZVBhcmFtcygpXG4gIH1cblxuICBjcmVhdGVTM0J1Y2tldCgpOiB2b2lkIHtcbiAgICB0aGlzLnNmdHBCdWNrZXQgPSBuZXcgQnVja2V0KHRoaXMsICdzZnRwLWJ1Y2tldCcsIHtcbiAgICAgIGJ1Y2tldE5hbWU6IHRoaXMuY29uZmlnLmJ1Y2tldE5hbWUsXG4gICAgICBlbmNyeXB0aW9uOiBCdWNrZXRFbmNyeXB0aW9uLlMzX01BTkFHRUQsXG4gICAgICBlbmZvcmNlU1NMOiB0cnVlLFxuICAgICAgcHVibGljUmVhZEFjY2VzczogZmFsc2UsXG4gICAgICBibG9ja1B1YmxpY0FjY2VzczogQmxvY2tQdWJsaWNBY2Nlc3MuQkxPQ0tfQUxMLFxuICAgICAgdmVyc2lvbmVkOiB0cnVlLFxuICAgICAgcmVtb3ZhbFBvbGljeTogUmVtb3ZhbFBvbGljeS5ERVNUUk9ZLFxuICAgIH0pO1xuICB9XG5cbiAgY3JlYXRlTG9nZ2luZ1JvbGUoKTogUm9sZSB7XG4gICAgcmV0dXJuIG5ldyBSb2xlKHRoaXMsIGBTRlRQTG9nZ2luZ1JvbGVgLCB7XG4gICAgICByb2xlTmFtZTogYCR7QXdzLlNUQUNLX05BTUV9LUxvZ2dpbmctUm9sZWAsXG4gICAgICBkZXNjcmlwdGlvbjogYExvZ2dpbmcgZm9yIFNGVFAgU2VydmllcmAsXG4gICAgICBhc3N1bWVkQnk6IG5ldyBDb21wb3NpdGVQcmluY2lwYWwobmV3IFNlcnZpY2VQcmluY2lwYWwoJ3RyYW5zZmVyLmFtYXpvbmF3cy5jb20nKSksXG4gICAgICBpbmxpbmVQb2xpY2llczoge1xuICAgICAgICBMb2dnaW5nUG9saWN5OiB0aGlzLmNyZWF0ZUxvZ2dpbmdQb2xpY3koKSxcbiAgICAgIH0sXG4gICAgfSk7XG4gIH1cblxuICAvLyAjIyMjIyMjIElBTSBST0xFUyAjIyMjIyMjXG4gIGNyZWF0ZUxvZ2dpbmdQb2xpY3koKTogUG9saWN5RG9jdW1lbnQge1xuICAgIGNvbnN0IGxvZ2dpbmdQb2xpY3kgPSBuZXcgUG9saWN5U3RhdGVtZW50KHtcbiAgICAgIHNpZDogJ1NGVFBDbG91ZFdhdGNoTG9nZ2luZycsXG4gICAgICBhY3Rpb25zOiBbJ2xvZ3M6Q3JlYXRlTG9nU3RyZWFtJywgJ2xvZ3M6RGVzY3JpYmVMb2dTdHJlYW1zJywgJ2xvZ3M6Q3JlYXRlTG9nR3JvdXAnLCAnbG9nczpQdXRMb2dFdmVudHMnXSxcbiAgICAgIGVmZmVjdDogRWZmZWN0LkFMTE9XLFxuICAgICAgcmVzb3VyY2VzOiBbJ2Fybjphd3M6bG9nczoqOio6bG9nLWdyb3VwOi9hd3MvdHJhbnNmZXIvKiddLFxuICAgIH0pO1xuXG4gICAgY29uc3QgdXNlckJ1Y2tldElubGluZVBvbGljeURvY3VtZW50ID0gbmV3IFBvbGljeURvY3VtZW50KHtcbiAgICAgIHN0YXRlbWVudHM6IFtsb2dnaW5nUG9saWN5XSxcbiAgICB9KTtcblxuICAgIHJldHVybiB1c2VyQnVja2V0SW5saW5lUG9saWN5RG9jdW1lbnQ7XG4gIH1cblxuICBjcmVhdGVFbGFzdGljSVBzKCk6IHZvaWQge1xuICAgIHRoaXMuZUlwcyA9IEFycmF5LmZyb20oQXJyYXkoMykua2V5cygpKS5tYXAoXG4gICAgICAoaSkgPT5cbiAgICAgICAgbmV3IENmbkVJUCh0aGlzLCBgRUlQJHtpfWAsIHtcbiAgICAgICAgICB0YWdzOiBbXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgIGtleTogJ05hbWUnLFxuICAgICAgICAgICAgICB2YWx1ZTogYCR7QXdzLlNUQUNLX05BTUV9LUVJUCR7aX1gLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICBdLFxuICAgICAgICB9KSxcbiAgICApO1xuICB9XG5cbiAgY3JlYXRlU0ZUUCgpOiB2b2lkIHtcbiAgICBjb25zdCBzZWN1cml0eUdyb3VwOiBTZWN1cml0eUdyb3VwID0gbmV3IFNlY3VyaXR5R3JvdXAodGhpcywgJ1NlY3VyaXR5R3JvdXAnLCB7XG4gICAgICB2cGM6IFZwYy5mcm9tTG9va3VwKHRoaXMsICdWUEMnLCB7XG4gICAgICAgIHZwY0lkOiB0aGlzLmNvbmZpZy52cGNJZCxcbiAgICAgIH0pLFxuICAgICAgYWxsb3dBbGxPdXRib3VuZDogdHJ1ZSxcbiAgICAgIHNlY3VyaXR5R3JvdXBOYW1lOiAnU0ZUUC1BY2Nlc3MnLFxuICAgICAgZGVzY3JpcHRpb246ICdTRlRQIEFjY2VzcycsXG4gICAgfSk7XG5cbiAgICAvLyAgSXRlcmF0ZSBvdmVyIHVzZXJzIGFuZCBhbGxvd2QgSVBTIGZvciBlYWNoIHVzZXIgYW5kIGFkZCBpdCB0byBzZWN1cml0eSBncm91cFxuICAgIE9iamVjdC5lbnRyaWVzKHRoaXMudXNlckNvbmZpZy51c2VycykubWFwKChbaSwgdXNlcl0pID0+XG4gICAgICB1c2VyLmFsbG93ZWRJcHMubWFwKChpcCkgPT5cbiAgICAgICAgc2VjdXJpdHlHcm91cC5hZGRJbmdyZXNzUnVsZShQZWVyLmlwdjQoaXApLCBQb3J0LnRjcCgyMiksIGBBbGxvdyBTRlRQIHRyYWZmaWMgZm9yIHVzZXIgLSAke3VzZXIubmFtZX1gKSxcbiAgICAgICksXG4gICAgKTtcblxuICAgIHRoaXMuc2Z0cFNlcnZlciA9IG5ldyBDZm5TZXJ2ZXIodGhpcywgJ1NGVFBTZXJ2ZXInLCB7XG4gICAgICBlbmRwb2ludFR5cGU6ICdWUEMnLFxuICAgICAgbG9nZ2luZ1JvbGU6IHRoaXMuY3JlYXRlTG9nZ2luZ1JvbGUoKS5yb2xlQXJuLFxuICAgICAgcHJvdG9jb2xzOiBbJ1NGVFAnXSxcbiAgICAgIGVuZHBvaW50RGV0YWlsczoge1xuICAgICAgICB2cGNJZDogdGhpcy5jb25maWcudnBjSWQsXG4gICAgICAgIGFkZHJlc3NBbGxvY2F0aW9uSWRzOiB0aGlzLmVJcHMubWFwKChlaXApID0+IGVpcC5hdHRyQWxsb2NhdGlvbklkKSxcbiAgICAgICAgLy8gd29ya3Mgd2lodCBwdWJsaWNcbiAgICAgICAgc3VibmV0SWRzOiBjb252ZXJ0U3RyaW5nVG9BcnJheSh0aGlzLmNvbmZpZy5wdWJsaWNTdWJuZXRJZHMpLFxuICAgICAgICBzZWN1cml0eUdyb3VwSWRzOiBbc2VjdXJpdHlHcm91cC5zZWN1cml0eUdyb3VwSWRdLFxuICAgICAgfSxcbiAgICB9KTtcbiAgfVxuXG4gIG91dHB1dEVJUEJ1Y2tldCgpOiB2b2lkIHtcbiAgICB0aGlzLmVJcHMubWFwKFxuICAgICAgKGVpcCwgaSkgPT5cbiAgICAgICAgbmV3IENmbk91dHB1dCh0aGlzLCBgRUlQT3V0cHV0JHtpfWAsIHtcbiAgICAgICAgICB2YWx1ZTogZWlwLnJlZixcbiAgICAgICAgICBkZXNjcmlwdGlvbjogYElQIEZvciBTRlRQIHNlcnZlcmAsXG4gICAgICAgICAgZXhwb3J0TmFtZTogYFNGVFAke2l9YCxcbiAgICAgICAgfSksXG4gICAgKTtcblxuICAgIG5ldyBDZm5PdXRwdXQodGhpcywgYFNGVFBCdWNrZXRPdXRwdXRgLCB7XG4gICAgICB2YWx1ZTogdGhpcy5zZnRwQnVja2V0LmJ1Y2tldE5hbWUsXG4gICAgICBkZXNjcmlwdGlvbjogYFNGVFAgUzMgQnVja2V0YCxcbiAgICAgIGV4cG9ydE5hbWU6IGBTRlRQQnVja2V0YCxcbiAgICB9KTtcbiAgfVxuXG59XG4iXX0=
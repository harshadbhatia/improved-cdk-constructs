"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.enableAWSLogServices = exports.createAWSLambdaARN = exports.configureLogCollection = exports.setupIntegration = void 0;
const client_secrets_manager_1 = require("@aws-sdk/client-secrets-manager");
const datadog_api_client_1 = require("@datadog/datadog-api-client");
const process_1 = require("process");
const API_KEY_SECRET = '/account/datadog/api-key';
const APP_KEY_SECRET = '/account/datadog/app-key';
const EXTERNAL_ID_SECRET = '/account/datadog/external-id';
async function setupIntegration(apiKey, appKey) {
    return await createAWSIntegration(apiKey, appKey)
        .then((externalId) => {
        if (externalId) {
            createExternalIDSecret(externalId);
            return externalId;
            // .then((data) => externalId)
            // .catch((err) => console.error("[Datadog] Unable to update external id to secret"))
        }
        else {
            // Could be an update // we get external id
            const s = getSecretValue(EXTERNAL_ID_SECRET, `[Datadog] Unable to get secret at ${EXTERNAL_ID_SECRET}`);
            return s;
            // .then((v) => JSON.parse(v).id)
            // .catch((err) => console.log("[Datadog]Unable to get secret"))
        }
    }).catch((err) => console.error("[Datadog] Unable to create AWS Integration", err));
}
exports.setupIntegration = setupIntegration;
async function createExternalIDSecret(externalId) {
    const client = getSecretManagerClient();
    const cmd = new client_secrets_manager_1.CreateSecretCommand({
        Name: EXTERNAL_ID_SECRET,
        Description: 'External ID associated with Datadog AWS Integration',
        SecretString: `{"id": "${externalId}"}`,
    });
    await client.send(cmd).then((data) => {
        console.log("[Datadog] External ID secret created");
        return 'OK';
    }).catch((err) => {
        console.error(`[Datadog] Unable to create secret at location /account/datadog/external-id`, err);
        process_1.exit(1);
    });
}
function getSecretManagerClient() {
    const client = new client_secrets_manager_1.SecretsManagerClient({ region: process.env.CDK_DEFAULT_REGION });
    return client;
}
async function getAPIKey(apiKey, appKey) {
    const apiKeyVal = await getSecretValue(apiKey, `[Datadog] Unable to find secret ${apiKey}. Ensure only value is stored in secret`);
    const appKeyVal = await getSecretValue(appKey, `[Datadog] Unable to find secret ${appKey}. Ensure only value is stored in secret`);
    return [apiKeyVal, appKeyVal];
}
async function getSecretValue(secretId, errorString) {
    const client = getSecretManagerClient();
    const cmd = new client_secrets_manager_1.GetSecretValueCommand({ SecretId: secretId });
    return await client.send(cmd).then((data) => {
        return data.SecretString;
    });
    // .catch((err) => {
    //     console.error(errorString)
    //     exit(1)
    // })
}
function createAPIInstance(apiKey, appKey) {
    const configuration = datadog_api_client_1.v1.createConfiguration({
        authMethods: {
            apiKeyAuth: apiKey,
            appKeyAuth: appKey
        }
    });
    const apiInstance = new datadog_api_client_1.v1.AWSIntegrationApi(configuration);
    return apiInstance;
}
async function createAWSIntegration(apiKey, appKey) {
    /**
     * Get all AWS tag filters returns "OK" response
     */
    return await getAPIKey(apiKey, appKey)
        .then(([apiKeyValue, appKeyValue]) => {
        console.log('[Datadog] Read secrets');
        const apiInstance = createAPIInstance(apiKeyValue, appKeyValue);
        return updateAWSAPIIntegration(apiInstance)
            .then((data) => {
            console.log("[Datadog] Updated account successfully");
            return;
        }).catch((error) => {
            console.log("[Datadog] Failed to update configuration, trying to create it instead");
            return createAWSAPIIntegration(apiInstance)
                .then((data) => { return data.externalId; })
                .catch((error) => { console.error(error); process_1.exit(1); });
        });
    }).catch((err) => {
        console.error("[Datadog] Failed to get APP Key", err);
        process_1.exit(1);
    });
}
function createAWSAPIIntegration(apiInstance) {
    const params = {
        body: {
            accountId: process.env.CDK_DEFAULT_ACCOUNT,
            filterTags: [`account_name:${process.env.ACCOUNT_NAME}`],
            hostTags: [`account_name:${process.env.ACCOUNT_NAME}`],
            metricsCollectionEnabled: true,
            resourceCollectionEnabled: true,
            cspmResourceCollectionEnabled: true,
            // excludedRegions: ["us-east-1", "us-west-2"],
            roleName: "DatadogAWSIntegrationRole",
        },
    };
    return apiInstance
        .createAWSAccount(params);
}
async function updateAWSAPIIntegration(apiInstance) {
    const params = {
        body: {
            accountId: process.env.CDK_DEFAULT_ACCOUNT,
            filterTags: [`account_name:${process.env.ACCOUNT_NAME}`],
            hostTags: [`account_name:${process.env.ACCOUNT_NAME}`],
            metricsCollectionEnabled: true,
            resourceCollectionEnabled: true,
        },
        accountId: process.env.CDK_DEFAULT_ACCOUNT,
        roleName: "DatadogAWSIntegrationRole",
    };
    return await apiInstance
        .updateAWSAccount(params);
}
// Deprecated ?
async function configureLogCollection(lambdaArn, services, secretKey) {
    // const secret = await getAPIKey(API_KEY_SECRET, APP_KEY_SECRET)
    const configuration = datadog_api_client_1.v1.createConfiguration({
        authMethods: {
            apiKeyAuth: API_KEY_SECRET,
            appKeyAuth: APP_KEY_SECRET
        }
    });
    // This is created after integration is created, along with forwarder stack.
    await createAWSLambdaARN(new datadog_api_client_1.v1.AWSLogsIntegrationApi(configuration), lambdaArn);
    await enableAWSLogServices(new datadog_api_client_1.v1.AWSLogsIntegrationApi(configuration), services);
}
exports.configureLogCollection = configureLogCollection;
async function createAWSLambdaARN(apiInstance, lambdaArn) {
    const params = {
        body: {
            accountId: process.env.CDK_DEFAULT_ACCOUNT,
            lambdaArn: lambdaArn,
        },
    };
    await apiInstance
        .createAWSLambdaARN(params)
        .then((data) => console.log("[Datadog] Lambda Integration for logs created"))
        .catch((error) => {
        console.error(error);
        process_1.exit(1);
    });
}
exports.createAWSLambdaARN = createAWSLambdaARN;
async function enableAWSLogServices(apiInstance, services = ["lambda"]) {
    const params = {
        body: {
            accountId: process.env.CDK_DEFAULT_ACCOUNT,
            services: services
        },
    };
    await apiInstance
        .enableAWSLogServices(params)
        .then((data) => console.log(`[Datadog] Enabled services for ${services}`))
        .catch((error) => { console.error(error); process_1.exit(1); });
}
exports.enableAWSLogServices = enableAWSLogServices;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2V0dXAtaW50ZWdyYXRpb24uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJzZXR1cC1pbnRlZ3JhdGlvbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSw0RUFBbUg7QUFDbkgsb0VBQWlEO0FBQ2pELHFDQUErQjtBQUUvQixNQUFNLGNBQWMsR0FBRywwQkFBMEIsQ0FBQTtBQUNqRCxNQUFNLGNBQWMsR0FBRywwQkFBMEIsQ0FBQTtBQUNqRCxNQUFNLGtCQUFrQixHQUFHLDhCQUE4QixDQUFBO0FBR2xELEtBQUssVUFBVSxnQkFBZ0IsQ0FBQyxNQUFjLEVBQUUsTUFBYztJQUNqRSxPQUFPLE1BQU0sb0JBQW9CLENBQUMsTUFBTSxFQUFFLE1BQU0sQ0FBQztTQUM1QyxJQUFJLENBQUMsQ0FBQyxVQUFVLEVBQUUsRUFBRTtRQUNqQixJQUFJLFVBQVUsRUFBRTtZQUNaLHNCQUFzQixDQUFDLFVBQVUsQ0FBQyxDQUFBO1lBQ2xDLE9BQU8sVUFBVSxDQUFBO1lBQ2pCLDhCQUE4QjtZQUM5QixxRkFBcUY7U0FDeEY7YUFBTTtZQUNILDJDQUEyQztZQUMzQyxNQUFNLENBQUMsR0FBRyxjQUFjLENBQUMsa0JBQWtCLEVBQUUscUNBQXFDLGtCQUFrQixFQUFFLENBQUMsQ0FBQTtZQUN2RyxPQUFPLENBQUMsQ0FBQTtZQUNSLGlDQUFpQztZQUNqQyxnRUFBZ0U7U0FDbkU7SUFFTCxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxHQUFHLEVBQUUsRUFBRSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsNENBQTRDLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQTtBQUczRixDQUFDO0FBbkJELDRDQW1CQztBQUVELEtBQUssVUFBVSxzQkFBc0IsQ0FBQyxVQUFrQjtJQUNwRCxNQUFNLE1BQU0sR0FBRyxzQkFBc0IsRUFBRSxDQUFBO0lBQ3ZDLE1BQU0sR0FBRyxHQUFHLElBQUksNENBQW1CLENBQUM7UUFDaEMsSUFBSSxFQUFFLGtCQUFrQjtRQUN4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QUcsQ0FBQyxtQkFBb0I7WUFDM0MsU0FBUyxFQUFFLFNBQVM7U0FDdkI7S0FDSixDQUFDO0lBRUYsTUFBTSxXQUFXO1NBQ1osa0JBQWtCLENBQUMsTUFBTSxDQUFDO1NBQzFCLElBQUksQ0FBQyxDQUFDLElBQVMsRUFBRSxFQUFFLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQywrQ0FBK0MsQ0FBQyxDQUFDO1NBQ2pGLEtBQUssQ0FBQyxDQUFDLEtBQVUsRUFBRSxFQUFFO1FBQ2xCLE9BQU8sQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUE7UUFDcEIsY0FBSSxDQUFDLENBQUMsQ0FBQyxDQUFBO0lBQ1gsQ0FBQyxDQUFDLENBQUM7QUFDWCxDQUFDO0FBaEJELGdEQWdCQztBQUVNLEtBQUssVUFBVSxvQkFBb0IsQ0FBQyxXQUFxQyxFQUFFLFFBQVEsR0FBRyxDQUFDLFFBQVEsQ0FBQztJQUVuRyxNQUFNLE1BQU0sR0FBd0Q7UUFDaEUsSUFBSSxFQUFFO1lBQ0YsU0FBUyxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsbUJBQW9CO1lBQzNDLFFBQVEsRUFBRSxRQUFRO1NBQ3JCO0tBQ0osQ0FBQztJQUVGLE1BQU0sV0FBVztTQUNaLG9CQUFvQixDQUFDLE1BQU0sQ0FBQztTQUM1QixJQUFJLENBQUMsQ0FBQyxJQUFTLEVBQUUsRUFBRSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsa0NBQWtDLFFBQVEsRUFBRSxDQUFDLENBQUM7U0FDOUUsS0FBSyxDQUFDLENBQUMsS0FBVSxFQUFFLEVBQUUsR0FBRyxPQUFPLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsY0FBSSxDQUFDLENBQUMsQ0FBQyxDQUFBLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDbEUsQ0FBQztBQWJELG9EQWFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ3JlYXRlU2VjcmV0Q29tbWFuZCwgR2V0U2VjcmV0VmFsdWVDb21tYW5kLCBTZWNyZXRzTWFuYWdlckNsaWVudCB9IGZyb20gXCJAYXdzLXNkay9jbGllbnQtc2VjcmV0cy1tYW5hZ2VyXCI7XG5pbXBvcnQgeyB2MSB9IGZyb20gXCJAZGF0YWRvZy9kYXRhZG9nLWFwaS1jbGllbnRcIjtcbmltcG9ydCB7IGV4aXQgfSBmcm9tIFwicHJvY2Vzc1wiO1xuXG5jb25zdCBBUElfS0VZX1NFQ1JFVCA9ICcvYWNjb3VudC9kYXRhZG9nL2FwaS1rZXknXG5jb25zdCBBUFBfS0VZX1NFQ1JFVCA9ICcvYWNjb3VudC9kYXRhZG9nL2FwcC1rZXknXG5jb25zdCBFWFRFUk5BTF9JRF9TRUNSRVQgPSAnL2FjY291bnQvZGF0YWRvZy9leHRlcm5hbC1pZCdcblxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gc2V0dXBJbnRlZ3JhdGlvbihhcGlLZXk6IHN0cmluZywgYXBwS2V5OiBzdHJpbmcpIHtcbiAgICByZXR1cm4gYXdhaXQgY3JlYXRlQVdTSW50ZWdyYXRpb24oYXBpS2V5LCBhcHBLZXkpXG4gICAgICAgIC50aGVuKChleHRlcm5hbElkKSA9PiB7XG4gICAgICAgICAgICBpZiAoZXh0ZXJuYWxJZCkge1xuICAgICAgICAgICAgICAgIGNyZWF0ZUV4dGVybmFsSURTZWNyZXQoZXh0ZXJuYWxJZClcbiAgICAgICAgICAgICAgICByZXR1cm4gZXh0ZXJuYWxJZFxuICAgICAgICAgICAgICAgIC8vIC50aGVuKChkYXRhKSA9PiBleHRlcm5hbElkKVxuICAgICAgICAgICAgICAgIC8vIC5jYXRjaCgoZXJyKSA9PiBjb25zb2xlLmVycm9yKFwiW0RhdGFkb2ddIFVuYWJsZSB0byB1cGRhdGUgZXh0ZXJuYWwgaWQgdG8gc2VjcmV0XCIpKVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAvLyBDb3VsZCBiZSBhbiB1cGRhdGUgLy8gd2UgZ2V0IGV4dGVybmFsIGlkXG4gICAgICAgICAgICAgICAgY29uc3QgcyA9IGdldFNlY3JldFZhbHVlKEVYVEVSTkFMX0lEX1NFQ1JFVCwgYFtEYXRhZG9nXSBVbmFibGUgdG8gZ2V0IHNlY3JldCBhdCAke0VYVEVSTkFMX0lEX1NFQ1JFVH1gKVxuICAgICAgICAgICAgICAgIHJldHVybiBzXG4gICAgICAgICAgICAgICAgLy8gLnRoZW4oKHYpID0+IEpTT04ucGFyc2UodikuaWQpXG4gICAgICAgICAgICAgICAgLy8gLmNhdGNoKChlcnIpID0+IGNvbnNvbGUubG9nKFwiW0RhdGFkb2ddVW5hYmxlIHRvIGdldCBzZWNyZXRcIikpXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgfSkuY2F0Y2goKGVycikgPT4gY29uc29sZS5lcnJvcihcIltEYXRhZG9nXSBVbmFibGUgdG8gY3JlYXRlIEFXUyBJbnRlZ3JhdGlvblwiLCBlcnIpKVxuXG5cbn1cblxuYXN5bmMgZnVuY3Rpb24gY3JlYXRlRXh0ZXJuYWxJRFNlY3JldChleHRlcm5hbElkOiBzdHJpbmcpIHtcbiAgICBjb25zdCBjbGllbnQgPSBnZXRTZWNyZXRNYW5hZ2VyQ2xpZW50KClcbiAgICBjb25zdCBjbWQgPSBuZXcgQ3JlYXRlU2VjcmV0Q29tbWFuZCh7XG4gICAgICAgIE5hbWU6IEVYVEVSTkFMX0lEX1NFQ1JFVCxcbiAgICAgICAgRGVzY3JpcHRpb246ICdFeHRlcm5hbCBJRCBhc3NvY2lhdGVkIHdpdGggRGF0YWRvZyBBV1MgSW50ZWdyYXRpb24nLFxuICAgICAgICBTZWNyZXRTdHJpbmc6IGB7XCJpZFwiOiBcIiR7ZXh0ZXJuYWxJZH1cIn1gLFxuICAgIH0pO1xuXG4gICAgYXdhaXQgY2xpZW50LnNlbmQoY21kKS50aGVuKChkYXRhKSA9PiB7XG4gICAgICAgIGNvbnNvbGUubG9nKFwiW0RhdGFkb2ddIEV4dGVybmFsIElEIHNlY3JldCBjcmVhdGVkXCIpXG4gICAgICAgIHJldHVybiAnT0snXG4gICAgfSkuY2F0Y2goKGVycikgPT4ge1xuICAgICAgICBjb25zb2xlLmVycm9yKGBbRGF0YWRvZ10gVW5hYmxlIHRvIGNyZWF0ZSBzZWNyZXQgYXQgbG9jYXRpb24gL2FjY291bnQvZGF0YWRvZy9leHRlcm5hbC1pZGAsIGVycilcbiAgICAgICAgZXhpdCgxKVxuICAgIH0pO1xuXG59XG5cbmZ1bmN0aW9uIGdldFNlY3JldE1hbmFnZXJDbGllbnQoKTogU2VjcmV0c01hbmFnZXJDbGllbnQge1xuICAgIGNvbnN0IGNsaWVudCA9IG5ldyBTZWNyZXRzTWFuYWdlckNsaWVudCh7IHJlZ2lvbjogcHJvY2Vzcy5lbnYuQ0RLX0RFRkFVTFRfUkVHSU9OIH0pXG4gICAgcmV0dXJuIGNsaWVudFxufVxuXG5hc3luYyBmdW5jdGlvbiBnZXRBUElLZXkoYXBpS2V5OiBzdHJpbmcsIGFwcEtleTogc3RyaW5nKSB7XG4gICAgY29uc3QgYXBpS2V5VmFsID0gYXdhaXQgZ2V0U2VjcmV0VmFsdWUoXG4gICAgICAgIGFwaUtleSxcbiAgICAgICAgYFtEYXRhZG9nXSBVbmFibGUgdG8gZmluZCBzZWNyZXQgJHthcGlLZXl9LiBFbnN1cmUgb25seSB2YWx1ZSBpcyBzdG9yZWQgaW4gc2VjcmV0YFxuICAgIClcbiAgICBjb25zdCBhcHBLZXlWYWwgPSBhd2FpdCBnZXRTZWNyZXRWYWx1ZShcbiAgICAgICAgYXBwS2V5LFxuICAgICAgICBgW0RhdGFkb2ddIFVuYWJsZSB0byBmaW5kIHNlY3JldCAke2FwcEtleX0uIEVuc3VyZSBvbmx5IHZhbHVlIGlzIHN0b3JlZCBpbiBzZWNyZXRgXG4gICAgKVxuXG4gICAgcmV0dXJuIFthcGlLZXlWYWwsIGFwcEtleVZhbF1cbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0U2VjcmV0VmFsdWUoc2VjcmV0SWQ6IHN0cmluZywgZXJyb3JTdHJpbmc6IHN0cmluZykge1xuICAgIGNvbnN0IGNsaWVudCA9IGdldFNlY3JldE1hbmFnZXJDbGllbnQoKVxuICAgIGNvbnN0IGNtZCA9IG5ldyBHZXRTZWNyZXRWYWx1ZUNvbW1hbmQoeyBTZWNyZXRJZDogc2VjcmV0SWQgfSlcblxuICAgIHJldHVybiBhd2FpdCBjbGllbnQuc2VuZChjbWQpLnRoZW4oKGRhdGE6IGFueSkgPT4ge1xuICAgICAgICByZXR1cm4gZGF0YS5TZWNyZXRTdHJpbmchXG4gICAgfSlcbiAgICAvLyAuY2F0Y2goKGVycikgPT4ge1xuICAgIC8vICAgICBjb25zb2xlLmVycm9yKGVycm9yU3RyaW5nKVxuICAgIC8vICAgICBleGl0KDEpXG4gICAgLy8gfSlcbn1cblxuZnVuY3Rpb24gY3JlYXRlQVBJSW5zdGFuY2UoYXBpS2V5OiBzdHJpbmcsIGFwcEtleTogc3RyaW5nKTogdjEuQVdTSW50ZWdyYXRpb25BcGkge1xuICAgIGNvbnN0IGNvbmZpZ3VyYXRpb24gPSB2MS5jcmVhdGVDb25maWd1cmF0aW9uKHtcbiAgICAgICAgYXV0aE1ldGhvZHM6IHtcbiAgICAgICAgICAgIGFwaUtleUF1dGg6IGFwaUtleSxcbiAgICAgICAgICAgIGFwcEtleUF1dGg6IGFwcEtleVxuICAgICAgICB9XG4gICAgfSk7XG4gICAgY29uc3QgYXBpSW5zdGFuY2UgPSBuZXcgdjEuQVdTSW50ZWdyYXRpb25BcGkoY29uZmlndXJhdGlvbik7XG5cbiAgICByZXR1cm4gYXBpSW5zdGFuY2Vcbn1cblxuYXN5bmMgZnVuY3Rpb24gY3JlYXRlQVdTSW50ZWdyYXRpb24oYXBpS2V5OiBzdHJpbmcsIGFwcEtleTogc3RyaW5nKTogUHJvbWlzZTxhbnk+IHtcbiAgICAvKipcbiAgICAgKiBHZXQgYWxsIEFXUyB0YWcgZmlsdGVycyByZXR1cm5zIFwiT0tcIiByZXNwb25zZVxuICAgICAqL1xuXG4gICAgcmV0dXJuIGF3YWl0IGdldEFQSUtleShhcGlLZXksIGFwcEtleSlcbiAgICAgICAgLnRoZW4oKFthcGlLZXlWYWx1ZSwgYXBwS2V5VmFsdWVdKSA9PiB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZygnW0RhdGFkb2ddIFJlYWQgc2VjcmV0cycpXG4gICAgICAgICAgICBjb25zdCBhcGlJbnN0YW5jZSA9IGNyZWF0ZUFQSUluc3RhbmNlKGFwaUtleVZhbHVlLCBhcHBLZXlWYWx1ZSlcbiAgICAgICAgICAgIHJldHVybiB1cGRhdGVBV1NBUElJbnRlZ3JhdGlvbihhcGlJbnN0YW5jZSlcbiAgICAgICAgICAgICAgICAudGhlbigoZGF0YTogYW55KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiW0RhdGFkb2ddIFVwZGF0ZWQgYWNjb3VudCBzdWNjZXNzZnVsbHlcIilcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuXG4gICAgICAgICAgICAgICAgfSkuY2F0Y2goKGVycm9yOiBhbnkpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJbRGF0YWRvZ10gRmFpbGVkIHRvIHVwZGF0ZSBjb25maWd1cmF0aW9uLCB0cnlpbmcgdG8gY3JlYXRlIGl0IGluc3RlYWRcIilcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZUFXU0FQSUludGVncmF0aW9uKGFwaUluc3RhbmNlKVxuICAgICAgICAgICAgICAgICAgICAgICAgLnRoZW4oKGRhdGE6IHYxLkFXU0FjY291bnRDcmVhdGVSZXNwb25zZSkgPT4geyByZXR1cm4gZGF0YS5leHRlcm5hbElkIH0pXG4gICAgICAgICAgICAgICAgICAgICAgICAuY2F0Y2goKGVycm9yOiBhbnkpID0+IHsgY29uc29sZS5lcnJvcihlcnJvcik7IGV4aXQoMSkgfSk7XG4gICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgfSkuY2F0Y2goKGVycikgPT4ge1xuICAgICAgICAgICAgY29uc29sZS5lcnJvcihcIltEYXRhZG9nXSBGYWlsZWQgdG8gZ2V0IEFQUCBLZXlcIiwgZXJyKVxuICAgICAgICAgICAgZXhpdCgxKVxuICAgICAgICB9KVxuXG59XG5cbmZ1bmN0aW9uIGNyZWF0ZUFXU0FQSUludGVncmF0aW9uKGFwaUluc3RhbmNlOiB2MS5BV1NJbnRlZ3JhdGlvbkFwaSk6IFByb21pc2U8YW55PiB7XG4gICAgY29uc3QgcGFyYW1zOiB2MS5BV1NJbnRlZ3JhdGlvbkFwaUNyZWF0ZUFXU0FjY291bnRSZXF1ZXN0ID0ge1xuICAgICAgICBib2R5OiB7XG4gICAgICAgICAgICBhY2NvdW50SWQ6IHByb2Nlc3MuZW52LkNES19ERUZBVUxUX0FDQ09VTlQhLFxuICAgICAgICAgICAgZmlsdGVyVGFnczogW2BhY2NvdW50X25hbWU6JHtwcm9jZXNzLmVudi5BQ0NPVU5UX05BTUV9YF0sXG4gICAgICAgICAgICBob3N0VGFnczogW2BhY2NvdW50X25hbWU6JHtwcm9jZXNzLmVudi5BQ0NPVU5UX05BTUV9YF0sXG4gICAgICAgICAgICBtZXRyaWNzQ29sbGVjdGlvbkVuYWJsZWQ6IHRydWUsXG4gICAgICAgICAgICByZXNvdXJjZUNvbGxlY3Rpb25FbmFibGVkOiB0cnVlLFxuICAgICAgICAgICAgY3NwbVJlc291cmNlQ29sbGVjdGlvbkVuYWJsZWQ6IHRydWUsXG4gICAgICAgICAgICAvLyBleGNsdWRlZFJlZ2lvbnM6IFtcInVzLWVhc3QtMVwiLCBcInVzLXdlc3QtMlwiXSxcbiAgICAgICAgICAgIHJvbGVOYW1lOiBcIkRhdGFkb2dBV1NJbnRlZ3JhdGlvblJvbGVcIixcbiAgICAgICAgfSxcbiAgICB9O1xuXG4gICAgcmV0dXJuIGFwaUluc3RhbmNlXG4gICAgICAgIC5jcmVhdGVBV1NBY2NvdW50KHBhcmFtcylcblxufVxuXG5hc3luYyBmdW5jdGlvbiB1cGRhdGVBV1NBUElJbnRlZ3JhdGlvbihhcGlJbnN0YW5jZTogdjEuQVdTSW50ZWdyYXRpb25BcGkpOiBQcm9taXNlPGFueT4ge1xuICAgIGNvbnN0IHBhcmFtczogdjEuQVdTSW50ZWdyYXRpb25BcGlVcGRhdGVBV1NBY2NvdW50UmVxdWVzdCA9IHtcbiAgICAgICAgYm9keToge1xuICAgICAgICAgICAgYWNjb3VudElkOiBwcm9jZXNzLmVudi5DREtfREVGQVVMVF9BQ0NPVU5UISxcbiAgICAgICAgICAgIGZpbHRlclRhZ3M6IFtgYWNjb3VudF9uYW1lOiR7cHJvY2Vzcy5lbnYuQUNDT1VOVF9OQU1FfWBdLFxuICAgICAgICAgICAgaG9zdFRhZ3M6IFtgYWNjb3VudF9uYW1lOiR7cHJvY2Vzcy5lbnYuQUNDT1VOVF9OQU1FfWBdLFxuICAgICAgICAgICAgbWV0cmljc0NvbGxlY3Rpb25FbmFibGVkOiB0cnVlLFxuICAgICAgICAgICAgcmVzb3VyY2VDb2xsZWN0aW9uRW5hYmxlZDogdHJ1ZSxcbiAgICAgICAgfSxcbiAgICAgICAgYWNjb3VudElkOiBwcm9jZXNzLmVudi5DREtfREVGQVVMVF9BQ0NPVU5UISxcbiAgICAgICAgcm9sZU5hbWU6IFwiRGF0YWRvZ0FXU0ludGVncmF0aW9uUm9sZVwiLFxuICAgIH07XG5cbiAgICByZXR1cm4gYXdhaXQgYXBpSW5zdGFuY2VcbiAgICAgICAgLnVwZGF0ZUFXU0FjY291bnQocGFyYW1zKVxufVxuXG4vLyBEZXByZWNhdGVkID9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBjb25maWd1cmVMb2dDb2xsZWN0aW9uKGxhbWJkYUFybjogc3RyaW5nLCBzZXJ2aWNlcz86IHN0cmluZ1tdLCBzZWNyZXRLZXk/OiBzdHJpbmcpIHtcbiAgICAvLyBjb25zdCBzZWNyZXQgPSBhd2FpdCBnZXRBUElLZXkoQVBJX0tFWV9TRUNSRVQsIEFQUF9LRVlfU0VDUkVUKVxuICAgIGNvbnN0IGNvbmZpZ3VyYXRpb24gPSB2MS5jcmVhdGVDb25maWd1cmF0aW9uKHtcbiAgICAgICAgYXV0aE1ldGhvZHM6IHtcbiAgICAgICAgICAgIGFwaUtleUF1dGg6IEFQSV9LRVlfU0VDUkVULFxuICAgICAgICAgICAgYXBwS2V5QXV0aDogQVBQX0tFWV9TRUNSRVRcbiAgICAgICAgfVxuICAgIH0pO1xuICAgIC8vIFRoaXMgaXMgY3JlYXRlZCBhZnRlciBpbnRlZ3JhdGlvbiBpcyBjcmVhdGVkLCBhbG9uZyB3aXRoIGZvcndhcmRlciBzdGFjay5cblxuICAgIGF3YWl0IGNyZWF0ZUFXU0xhbWJkYUFSTihuZXcgdjEuQVdTTG9nc0ludGVncmF0aW9uQXBpKGNvbmZpZ3VyYXRpb24pLCBsYW1iZGFBcm4pXG4gICAgYXdhaXQgZW5hYmxlQVdTTG9nU2VydmljZXMobmV3IHYxLkFXU0xvZ3NJbnRlZ3JhdGlvbkFwaShjb25maWd1cmF0aW9uKSwgc2VydmljZXMpXG5cblxufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gY3JlYXRlQVdTTGFtYmRhQVJOKGFwaUluc3RhbmNlOiB2MS5BV1NMb2dzSW50ZWdyYXRpb25BcGksIGxhbWJkYUFybjogc3RyaW5nKSB7XG5cbiAgICBjb25zdCBwYXJhbXM6IHYxLkFXU0xvZ3NJbnRlZ3JhdGlvbkFwaUNyZWF0ZUFXU0xhbWJkYUFSTlJlcXVlc3QgPSB7XG4gICAgICAgIGJvZHk6IHtcbiAgICAgICAgICAgIGFjY291bnRJZDogcHJvY2Vzcy5lbnYuQ0RLX0RFRkFVTFRfQUNDT1VOVCEsXG4gICAgICAgICAgICBsYW1iZGFBcm46IGxhbWJkYUFybixcbiAgICAgICAgfSxcbiAgICB9O1xuXG4gICAgYXdhaXQgYXBpSW5zdGFuY2VcbiAgICAgICAgLmNyZWF0ZUFXU0xhbWJkYUFSTihwYXJhbXMpXG4gICAgICAgIC50aGVuKChkYXRhOiBhbnkpID0+IGNvbnNvbGUubG9nKFwiW0RhdGFkb2ddIExhbWJkYSBJbnRlZ3JhdGlvbiBmb3IgbG9ncyBjcmVhdGVkXCIpKVxuICAgICAgICAuY2F0Y2goKGVycm9yOiBhbnkpID0+IHtcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyb3IpXG4gICAgICAgICAgICBleGl0KDEpXG4gICAgICAgIH0pO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZW5hYmxlQVdTTG9nU2VydmljZXMoYXBpSW5zdGFuY2U6IHYxLkFXU0xvZ3NJbnRlZ3JhdGlvbkFwaSwgc2VydmljZXMgPSBbXCJsYW1iZGFcIl0pIHtcblxuICAgIGNvbnN0IHBhcmFtczogdjEuQVdTTG9nc0ludGVncmF0aW9uQXBpRW5hYmxlQVdTTG9nU2VydmljZXNSZXF1ZXN0ID0ge1xuICAgICAgICBib2R5OiB7XG4gICAgICAgICAgICBhY2NvdW50SWQ6IHByb2Nlc3MuZW52LkNES19ERUZBVUxUX0FDQ09VTlQhLFxuICAgICAgICAgICAgc2VydmljZXM6IHNlcnZpY2VzXG4gICAgICAgIH0sXG4gICAgfTtcblxuICAgIGF3YWl0IGFwaUluc3RhbmNlXG4gICAgICAgIC5lbmFibGVBV1NMb2dTZXJ2aWNlcyhwYXJhbXMpXG4gICAgICAgIC50aGVuKChkYXRhOiBhbnkpID0+IGNvbnNvbGUubG9nKGBbRGF0YWRvZ10gRW5hYmxlZCBzZXJ2aWNlcyBmb3IgJHtzZXJ2aWNlc31gKSlcbiAgICAgICAgLmNhdGNoKChlcnJvcjogYW55KSA9PiB7IGNvbnNvbGUuZXJyb3IoZXJyb3IpOyBleGl0KDEpIH0pO1xufVxuIl19
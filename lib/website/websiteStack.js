"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.WebsiteStack = void 0;
const iam = require("aws-cdk-lib/aws-iam");
const ssm = require("aws-cdk-lib/aws-ssm");
const route53 = require("aws-cdk-lib/aws-route53");
const acm = require("aws-cdk-lib/aws-certificatemanager");
const cloudfront = require("aws-cdk-lib/aws-cloudfront");
const origins = require("aws-cdk-lib/aws-cloudfront-origins");
const targets = require("aws-cdk-lib/aws-route53-targets");
const s3 = require("aws-cdk-lib/aws-s3");
const cdk = require("aws-cdk-lib");
const aws_cdk_lib_1 = require("aws-cdk-lib");
const aws_cloudfront_1 = require("aws-cdk-lib/aws-cloudfront");
class WebsiteStack extends cdk.Stack {
    constructor(scope, id, config, props) {
        var _a;
        super(scope, id, props);
        this.config = config;
        const hostingBucket = new s3.Bucket(this, this.config.website.bucket.bucketName, {
            bucketName: this.config.website.bucket.bucketName,
            websiteIndexDocument: 'index.html',
            websiteErrorDocument: 'error.html',
            publicReadAccess: true,
            removalPolicy: cdk.RemovalPolicy.DESTROY,
            enforceSSL: true,
            encryption: s3.BucketEncryption.S3_MANAGED,
        });
        hostingBucket.grantReadWrite(new iam.ArnPrincipal(`arn:aws:iam::${cdk.Stack.of(this).account}:role/buildkite-deployment-role`));
        const originAccessIdentity = new cloudfront.OriginAccessIdentity(this, "OriginAccessIdentiy");
        hostingBucket.grantRead(originAccessIdentity);
        const acmArn = ssm.StringParameter.valueForStringParameter(this, `/acm/${this.config.website.domain}`);
        const certificate = acm.Certificate.fromCertificateArn(this, "Certificate", acmArn);
        const origin = new origins.S3Origin(hostingBucket, { originAccessIdentity });
        var defaultBehavior = {
            origin: origin,
            viewerProtocolPolicy: cloudfront.ViewerProtocolPolicy.REDIRECT_TO_HTTPS,
        };
        // If config is passed
        if (this.config.website.responseHeaderBehaviour) {
            var shb;
            if (this.config.website.responseHeaderBehaviour.strictTransportSecurity) {
                const t = aws_cdk_lib_1.Duration.seconds(Number(this.config.website.responseHeaderBehaviour.strictTransportSecurity.accessControlMaxAge));
                // Duration doesnt have the method to convert config
                shb = {
                    ...this.config.website.responseHeaderBehaviour,
                    strictTransportSecurity: {
                        ...this.config.website.responseHeaderBehaviour.strictTransportSecurity,
                        accessControlMaxAge: t
                    }
                };
            }
            else {
                shb = this.config.website.responseHeaderBehaviour;
            }
            const responseHeaderPolicy = new cloudfront.ResponseHeadersPolicy(this, 'ResponseHeadersPolicy', {
                responseHeadersPolicyName: this.config.website.responseHeaderName || 'ResponseHeaderCustomPolicy',
                comment: 'A default response policy with security headers',
                securityHeadersBehavior: shb,
            });
            defaultBehavior = {
                origin: origin,
                viewerProtocolPolicy: cloudfront.ViewerProtocolPolicy.REDIRECT_TO_HTTPS,
                responseHeadersPolicy: responseHeaderPolicy
            };
        }
        const al = this.config.website.certificateAliases ? [this.config.website.domain, ...this.config.website.certificateAliases] : [this.config.website.domain];
        // Use new style distribution
        const cf = new cloudfront.Distribution(this, 'WebDistribution', {
            comment: this.config.website.domain,
            httpVersion: aws_cloudfront_1.HttpVersion.HTTP2_AND_3,
            webAclId: this.config.website.webACLId ? this.config.website.webACLId : undefined,
            defaultBehavior: defaultBehavior,
            errorResponses: [
                {
                    httpStatus: 403,
                    responseHttpStatus: 200,
                    responsePagePath: '/index.html'
                }
            ],
            domainNames: al,
            certificate: certificate,
            minimumProtocolVersion: cloudfront.SecurityPolicyProtocol.TLS_V1_2_2021
        });
        // incase we have cross account hosting zone domains to support
        var d;
        if (this.config.website.ignorePrefix && this.config.website.domain.startsWith(this.config.website.ignorePrefix)) {
            d = this.config.website.domain.split(".").slice(1).join(".");
        }
        else {
            d = this.config.website.domain;
        }
        const zoneId = ssm.StringParameter.valueForStringParameter(this, `/route53/${d}/zone`);
        const zone = route53.HostedZone.fromHostedZoneAttributes(this, "DomainHostedZone", {
            zoneName: d,
            hostedZoneId: zoneId,
        });
        // // Adding out A Record code
        new route53.ARecord(this, "CDNARecord", {
            recordName: this.config.website.domain,
            ttl: cdk.Duration.seconds(60),
            zone,
            target: route53.RecordTarget.fromAlias(new targets.CloudFrontTarget(cf)),
        });
        new route53.AaaaRecord(this, "AliasRecord", {
            recordName: this.config.website.domain,
            ttl: cdk.Duration.seconds(60),
            zone,
            target: route53.RecordTarget.fromAlias(new targets.CloudFrontTarget(cf)),
        });
        (_a = this.config.website.addtionalARecords) === null || _a === void 0 ? void 0 : _a.map(r => {
            new route53.ARecord(this, `${r.recordName}CDNARecord`, {
                recordName: r.recordName,
                ttl: cdk.Duration.seconds(r.ttl),
                zone,
                target: route53.RecordTarget.fromAlias(new targets.CloudFrontTarget(cf)),
            });
        });
    }
}
exports.WebsiteStack = WebsiteStack;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2Vic2l0ZVN0YWNrLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsid2Vic2l0ZVN0YWNrLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLDJDQUE0QztBQUM1QywyQ0FBNEM7QUFDNUMsbURBQW9EO0FBQ3BELDBEQUEyRDtBQUMzRCx5REFBMEQ7QUFDMUQsOERBQStEO0FBQy9ELDJEQUE0RDtBQUM1RCx5Q0FBMEM7QUFDMUMsbUNBQW9DO0FBR3BDLDZDQUF1QztBQUN2QywrREFBMkc7QUFJM0csTUFBYSxZQUFhLFNBQVEsR0FBRyxDQUFDLEtBQUs7SUFJdkMsWUFBWSxLQUFnQixFQUFFLEVBQVUsRUFBRSxNQUFxQixFQUFFLEtBQXNCOztRQUNuRixLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUV4QixJQUFJLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQztRQUVyQixNQUFNLGFBQWEsR0FBRyxJQUFJLEVBQUUsQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxVQUFVLEVBQUU7WUFDN0UsVUFBVSxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxVQUFVO1lBQ2pELG9CQUFvQixFQUFFLFlBQVk7WUFDbEMsb0JBQW9CLEVBQUUsWUFBWTtZQUNsQyxnQkFBZ0IsRUFBRSxJQUFJO1lBQ3RCLGFBQWEsRUFBRSxHQUFHLENBQUMsYUFBYSxDQUFDLE9BQU87WUFDeEMsVUFBVSxFQUFFLElBQUk7WUFDaEIsVUFBVSxFQUFFLEVBQUUsQ0FBQyxnQkFBZ0IsQ0FBQyxVQUFVO1NBQzdDLENBQUMsQ0FBQTtRQUdGLGFBQWEsQ0FBQyxjQUFjLENBQUMsSUFBSSxHQUFHLENBQUMsWUFBWSxDQUFDLGdCQUFnQixHQUFHLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxPQUFPLGlDQUFpQyxDQUFD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LENBQUMsSUFBSSxPQUFPLENBQUMsZ0JBQWdCLENBQUMsRUFBRSxDQUFDLENBQUM7YUFDM0UsQ0FBQyxDQUFDO1FBQ1AsQ0FBQyxDQUFDLENBQUE7SUFDTixDQUFDO0NBQ0o7QUFuSUQsb0NBbUlDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGlhbSA9IHJlcXVpcmUoJ2F3cy1jZGstbGliL2F3cy1pYW0nKTtcbmltcG9ydCBzc20gPSByZXF1aXJlKCdhd3MtY2RrLWxpYi9hd3Mtc3NtJyk7XG5pbXBvcnQgcm91dGU1MyA9IHJlcXVpcmUoJ2F3cy1jZGstbGliL2F3cy1yb3V0ZTUzJyk7XG5pbXBvcnQgYWNtID0gcmVxdWlyZSgnYXdzLWNkay1saWIvYXdzLWNlcnRpZmljYXRlbWFuYWdlcicpO1xuaW1wb3J0IGNsb3VkZnJvbnQgPSByZXF1aXJlKCdhd3MtY2RrLWxpYi9hd3MtY2xvdWRmcm9udCcpO1xuaW1wb3J0IG9yaWdpbnMgPSByZXF1aXJlKCdhd3MtY2RrLWxpYi9hd3MtY2xvdWRmcm9udC1vcmlnaW5zJyk7XG5pbXBvcnQgdGFyZ2V0cyA9IHJlcXVpcmUoJ2F3cy1jZGstbGliL2F3cy1yb3V0ZTUzLXRhcmdldHMnKTtcbmltcG9ydCBzMyA9IHJlcXVpcmUoJ2F3cy1jZGstbGliL2F3cy1zMycpO1xuaW1wb3J0IGNkayA9IHJlcXVpcmUoJ2F3cy1jZGstbGliJyk7XG5pbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tICdjb25zdHJ1Y3RzJztcbmltcG9ydCB7IFdlYnNpdGVDb25maWcgfSBmcm9tICcuLi8uLi9pbnRlcmZhY2VzL2xpYi93ZWJzaXRlL2ludGVyZmFjZXMnO1xuaW1wb3J0IHsgRHVyYXRpb24gfSBmcm9tICdhd3MtY2RrLWxpYic7XG5pbXBvcnQgeyBCZWhhdmlvck9wdGlvbnMsIEh0dHBWZXJzaW9uLCBSZXNwb25zZVNlY3VyaXR5SGVhZGVyc0JlaGF2aW9yIH0gZnJvbSAnYXdzLWNkay1saWIvYXdzLWNsb3VkZnJvbnQnO1xuaW1wb3J0IHsgZXhpdCB9IGZyb20gJ3Byb2Nlc3MnO1xuXG5cbmV4cG9ydCBjbGFzcyBXZWJzaXRlU3RhY2sgZXh0ZW5kcyBjZGsuU3RhY2sge1xuXG4gICAgY29uZmlnOiBXZWJzaXRlQ29uZmlnO1xuXG4gICAgY29uc3RydWN0b3Ioc2NvcGU6IENvbnN0cnVjdCwgaWQ6IHN0cmluZywgY29uZmlnOiBXZWJzaXRlQ29uZmlnLCBwcm9wcz86IGNkay5TdGFja1Byb3BzKSB7XG4gICAgICAgIHN1cGVyKHNjb3BlLCBpZCwgcHJvcHMpO1xuXG4gICAgICAgIHRoaXMuY29uZmlnID0gY29uZmlnO1xuXG4gICAgICAgIGNvbnN0IGhvc3RpbmdCdWNrZXQgPSBuZXcgczMuQnVja2V0KHRoaXMsIHRoaXMuY29uZmlnLndlYnNpdGUuYnVja2V0LmJ1Y2tldE5hbWUsIHtcbiAgICAgICAgICAgIGJ1Y2tldE5hbWU6IHRoaXMuY29uZmlnLndlYnNpdGUuYnVja2V0LmJ1Y2tldE5hbWUsXG4gICAgICAgICAgICB3ZWJzaXRlSW5kZXhEb2N1bWVudDogJ2luZGV4Lmh0bWwnLFxuICAgICAgICAgICAgd2Vic2l0ZUVycm9yRG9jdW1lbnQ6ICdlcnJvci5odG1sJywgLy8gQ2xvdWRGb3JtYXRpb24gZG9lc24ndCByZXF1aXJlIHRoaXMgYnV0IHRoZSBTMyBjb25zb2xlIHVpIGRvZXNcbiAgICAgICAgICAgIHB1YmxpY1JlYWRBY2Nlc3M6IHRydWUsXG4gICAgICAgICAgICByZW1vdmFsUG9saWN5OiBjZGsuUmVtb3ZhbFBvbGljeS5ERVNUUk9ZLFxuICAgICAgICAgICAgZW5mb3JjZVNTTDogdHJ1ZSxcbiAgICAgICAgICAgIGVuY3J5cHRpb246IHMzLkJ1Y2tldEVuY3J5cHRpb24uUzNfTUFOQUdFRCxcbiAgICAgICAgfSlcblxuXG4gICAgICAgIGhvc3RpbmdCdWNrZXQuZ3JhbnRSZWFkV3JpdGUobmV3IGlhbS5Bcm5QcmluY2lwYWwoYGFybjphd3M6aWFtOjoke2Nkay5TdGFjay5vZih0aGlzKS5hY2NvdW50fTpyb2xlL2J1aWxka2l0ZS1kZXBsb3ltZW50LXJvbGVgKSlcblxuICAgICAgICBjb25zdCBvcmlnaW5BY2Nlc3NJZGVudGl0eSA9IG5ldyBjbG91ZGZyb250Lk9yaWdpbkFjY2Vzc0lkZW50aXR5KFxuICAgICAgICAgICAgdGhpcyxcbiAgICAgICAgICAgIFwiT3JpZ2luQWNjZXNzSWRlbnRpeVwiXG4gICAgICAgIClcbiAgICAgICAgaG9zdGluZ0J1Y2tldC5ncmFudFJlYWQob3JpZ2luQWNjZXNzSWRlbnRpdHkpXG4gICAgICAgIGNvbnN0IGFjbUFybiA9IHNzbS5TdHJpbmdQYXJhbWV0ZXIudmFsdWVGb3JTdHJpbmdQYXJhbWV0ZXIoXG4gICAgICAgICAgICB0aGlzLCBgL2FjbS8ke3RoaXMuY29uZmlnLndlYnNpdGUuZG9tYWlufWBcbiAgICAgICAgKVxuXG4gICAgICAgIGNvbnN0IGNlcnRpZmljYXRlID0gYWNtLkNlcnRpZmljYXRlLmZyb21DZXJ0aWZpY2F0ZUFybih0aGlzLCBcIkNlcnRpZmljYXRlXCIsIGFjbUFybik7XG5cbiAgICAgICAgY29uc3Qgb3JpZ2luID0gbmV3IG9yaWdpbnMuUzNPcmlnaW4oaG9zdGluZ0J1Y2tldCwge29yaWdpbkFjY2Vzc0lkZW50aXR5fSlcbiAgICAgICAgdmFyIGRlZmF1bHRCZWhhdmlvcjogQmVoYXZpb3JPcHRpb25zID0ge1xuICAgICAgICAgICAgb3JpZ2luOiBvcmlnaW4sXG4gICAgICAgICAgICB2aWV3ZXJQcm90b2NvbFBvbGljeTogY2xvdWRmcm9udC5WaWV3ZXJQcm90b2NvbFBvbGljeS5SRURJUkVDVF9UT19IVFRQUyxcbiAgICAgICAgfVxuICAgICAgICAvLyBJZiBjb25maWcgaXMgcGFzc2VkXG4gICAgICAgIGlmICh0aGlzLmNvbmZpZy53ZWJzaXRlLnJlc3BvbnNlSGVhZGVyQmVoYXZpb3VyKSB7XG4gICAgICAgICAgICB2YXIgc2hiOiBSZXNwb25zZVNlY3VyaXR5SGVhZGVyc0JlaGF2aW9yXG5cbiAgICAgICAgICAgIGlmICh0aGlzLmNvbmZpZy53ZWJzaXRlLnJlc3BvbnNlSGVhZGVyQmVoYXZpb3VyLnN0cmljdFRyYW5zcG9ydFNlY3VyaXR5KSB7XG4gICAgICAgICAgICAgICAgY29uc3QgdCA9IER1cmF0aW9uLnNlY29uZHMoTnVtYmVyKHRoaXMuY29uZmlnLndlYnNpdGUucmVzcG9uc2VIZWFkZXJCZWhhdmlvdXIuc3RyaWN0VHJhbnNwb3J0U2VjdXJpdHkuYWNjZXNzQ29udHJvbE1heEFnZSkpXG4gICAgICAgICAgICAgICAgLy8gRHVyYXRpb24gZG9lc250IGhhdmUgdGhlIG1ldGhvZCB0byBjb252ZXJ0IGNvbmZpZ1xuICAgICAgICAgICAgICAgIHNoYiA9IHtcbiAgICAgICAgICAgICAgICAgICAgLi4udGhpcy5jb25maWcud2Vic2l0ZS5yZXNwb25zZUhlYWRlckJlaGF2aW91cixcbiAgICAgICAgICAgICAgICAgICAgc3RyaWN0VHJhbnNwb3J0U2VjdXJpdHk6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC4uLnRoaXMuY29uZmlnLndlYnNpdGUucmVzcG9uc2VIZWFkZXJCZWhhdmlvdXIuc3RyaWN0VHJhbnNwb3J0U2VjdXJpdHksXG4gICAgICAgICAgICAgICAgICAgICAgICBhY2Nlc3NDb250cm9sTWF4QWdlOiB0XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHNoYiA9IHRoaXMuY29uZmlnLndlYnNpdGUucmVzcG9uc2VIZWFkZXJCZWhhdmlvdXJcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY29uc3QgcmVzcG9uc2VIZWFkZXJQb2xpY3kgPSBuZXcgY2xvdWRmcm9udC5SZXNwb25zZUhlYWRlcnNQb2xpY3kodGhpcywgJ1Jlc3BvbnNlSGVhZGVyc1BvbGljeScsIHtcbiAgICAgICAgICAgICAgICByZXNwb25zZUhlYWRlcnNQb2xpY3lOYW1lOiB0aGlzLmNvbmZpZy53ZWJzaXRlLnJlc3BvbnNlSGVhZGVyTmFtZSB8fCAnUmVzcG9uc2VIZWFkZXJDdXN0b21Qb2xpY3knLFxuICAgICAgICAgICAgICAgIGNvbW1lbnQ6ICdBIGRlZmF1bHQgcmVzcG9uc2UgcG9saWN5IHdpdGggc2VjdXJpdHkgaGVhZGVycycsXG4gICAgICAgICAgICAgICAgc2VjdXJpdHlIZWFkZXJzQmVoYXZpb3I6IHNoYixcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBkZWZhdWx0QmVoYXZpb3IgPSB7XG4gICAgICAgICAgICAgICAgb3JpZ2luOiBvcmlnaW4sXG4gICAgICAgICAgICAgICAgdmlld2VyUHJvdG9jb2xQb2xpY3k6IGNsb3VkZnJvbnQuVmlld2VyUHJvdG9jb2xQb2xpY3kuUkVESVJFQ1RfVE9fSFRUUFMsXG4gICAgICAgICAgICAgICAgcmVzcG9uc2VIZWFkZXJzUG9saWN5OiByZXNwb25zZUhlYWRlclBvbGljeVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgYWwgPSB0aGlzLmNvbmZpZy53ZWJzaXRlLmNlcnRpZmljYXRlQWxpYXNlcyA/IFt0aGlzLmNvbmZpZy53ZWJzaXRlLmRvbWFpbiwgLi4udGhpcy5jb25maWcud2Vic2l0ZS5jZXJ0aWZpY2F0ZUFsaWFzZXNdIDogW3RoaXMuY29uZmlnLndlYnNpdGUuZG9tYWluXVxuICAgICAgICAvLyBVc2UgbmV3IHN0eWxlIGRpc3RyaWJ1dGlvblxuICAgICAgICBjb25zdCBjZiA9IG5ldyBjbG91ZGZyb250LkRpc3RyaWJ1dGlvbih0aGlzLCAnV2ViRGlzdHJpYnV0aW9uJywge1xuICAgICAgICAgICAgY29tbWVudDogdGhpcy5jb25maWcud2Vic2l0ZS5kb21haW4sXG4gICAgICAgICAgICBodHRwVmVyc2lvbjogSHR0cFZlcnNpb24uSFRUUDJfQU5EXzMsXG4gICAgICAgICAgICB3ZWJBY2xJZDogdGhpcy5jb25maWcud2Vic2l0ZS53ZWJBQ0xJZCA/IHRoaXMuY29uZmlnLndlYnNpdGUud2ViQUNMSWQgOiB1bmRlZmluZWQsXG4gICAgICAgICAgICBkZWZhdWx0QmVoYXZpb3I6IGRlZmF1bHRCZWhhdmlvcixcbiAgICAgICAgICAgIGVycm9yUmVzcG9uc2VzOiBbXG4gICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICBodHRwU3RhdHVzOiA0MDMsXG4gICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlSHR0cFN0YXR1czogMjAwLFxuICAgICAgICAgICAgICAgICAgICByZXNwb25zZVBhZ2VQYXRoOiAnL2luZGV4Lmh0bWwnXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgXSxcbiAgICAgICAgICAgIGRvbWFpbk5hbWVzOiBhbCxcbiAgICAgICAgICAgIGNlcnRpZmljYXRlOiBjZXJ0aWZpY2F0ZSxcbiAgICAgICAgICAgIG1pbmltdW1Qcm90b2NvbFZlcnNpb246IGNsb3VkZnJvbnQuU2VjdXJpdHlQb2xpY3lQcm90b2NvbC5UTFNfVjFfMl8yMDIxXG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIGluY2FzZSB3ZSBoYXZlIGNyb3NzIGFjY291bnQgaG9zdGluZyB6b25lIGRvbWFpbnMgdG8gc3VwcG9ydFxuICAgICAgICB2YXIgZDogc3RyaW5nXG5cbiAgICAgICAgaWYgKHRoaXMuY29uZmlnLndlYnNpdGUuaWdub3JlUHJlZml4ICYmIHRoaXMuY29uZmlnLndlYnNpdGUuZG9tYWluLnN0YXJ0c1dpdGgodGhpcy5jb25maWcud2Vic2l0ZS5pZ25vcmVQcmVmaXgpKSB7XG4gICAgICAgICAgICBkID0gdGhpcy5jb25maWcud2Vic2l0ZS5kb21haW4uc3BsaXQoXCIuXCIpLnNsaWNlKDEpLmpvaW4oXCIuXCIpO1xuXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBkID0gdGhpcy5jb25maWcud2Vic2l0ZS5kb21haW5cbiAgICAgICAgfVxuXG5cbiAgICAgICAgY29uc3Qgem9uZUlkID0gc3NtLlN0cmluZ1BhcmFtZXRlci52YWx1ZUZvclN0cmluZ1BhcmFtZXRlcih0aGlzLCBgL3JvdXRlNTMvJHtkfS96b25lYClcbiAgICAgICAgY29uc3Qgem9uZSA9IHJvdXRlNTMuSG9zdGVkWm9uZS5mcm9tSG9zdGVkWm9uZUF0dHJpYnV0ZXModGhpcywgXCJEb21haW5Ib3N0ZWRab25lXCIsXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgem9uZU5hbWU6IGQsXG4gICAgICAgICAgICAgICAgaG9zdGVkWm9uZUlkOiB6b25lSWQsXG4gICAgICAgICAgICB9XG4gICAgICAgICk7XG5cbiAgICAgICAgLy8gLy8gQWRkaW5nIG91dCBBIFJlY29yZCBjb2RlXG4gICAgICAgIG5ldyByb3V0ZTUzLkFSZWNvcmQodGhpcywgXCJDRE5BUmVjb3JkXCIsIHtcbiAgICAgICAgICAgIHJlY29yZE5hbWU6IHRoaXMuY29uZmlnLndlYnNpdGUuZG9tYWluLFxuICAgICAgICAgICAgdHRsOiBjZGsuRHVyYXRpb24uc2Vjb25kcyg2MCksXG4gICAgICAgICAgICB6b25lLFxuICAgICAgICAgICAgdGFyZ2V0OiByb3V0ZTUzLlJlY29yZFRhcmdldC5mcm9tQWxpYXMobmV3IHRhcmdldHMuQ2xvdWRGcm9udFRhcmdldChjZikpLFxuICAgICAgICB9KTtcblxuICAgICAgICBuZXcgcm91dGU1My5BYWFhUmVjb3JkKHRoaXMsIFwiQWxpYXNSZWNvcmRcIiwge1xuICAgICAgICAgICAgcmVjb3JkTmFtZTogdGhpcy5jb25maWcud2Vic2l0ZS5kb21haW4sXG4gICAgICAgICAgICB0dGw6IGNkay5EdXJhdGlvbi5zZWNvbmRzKDYwKSxcbiAgICAgICAgICAgIHpvbmUsXG4gICAgICAgICAgICB0YXJnZXQ6IHJvdXRlNTMuUmVjb3JkVGFyZ2V0LmZyb21BbGlhcyhuZXcgdGFyZ2V0cy5DbG91ZEZyb250VGFyZ2V0KGNmKSksXG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMuY29uZmlnLndlYnNpdGUuYWRkdGlvbmFsQVJlY29yZHM/Lm1hcChyID0+IHtcbiAgICAgICAgICAgIG5ldyByb3V0ZTUzLkFSZWNvcmQodGhpcywgYCR7ci5yZWNvcmROYW1lfUNETkFSZWNvcmRgLCB7XG4gICAgICAgICAgICAgICAgcmVjb3JkTmFtZTogci5yZWNvcmROYW1lLFxuICAgICAgICAgICAgICAgIHR0bDogY2RrLkR1cmF0aW9uLnNlY29uZHMoci50dGwpLFxuICAgICAgICAgICAgICAgIHpvbmUsXG4gICAgICAgICAgICAgICAgdGFyZ2V0OiByb3V0ZTUzLlJlY29yZFRhcmdldC5mcm9tQWxpYXMobmV3IHRhcmdldHMuQ2xvdWRGcm9udFRhcmdldChjZikpLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pXG4gICAgfVxufVxuIl19